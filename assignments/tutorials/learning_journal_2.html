<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Python Learning Journal: Step 2 &mdash; Python 401 2.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Python 401 2.1 documentation" href="../../index.html" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />

<link rel="stylesheet" href="../../_static/custom.css" type="text/css" media="screen" charset="utf-8" />

<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head>
  <body role="document">
<div class="header">
  <div class="logo">
    <a href="../../index.html">
      <img class="logo" src="../../_static/cf_logo.png" alt="Logo"/>
      <p>Code Fellows</p>
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Python 401 2.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput > div,
div.nbinput div[class^=highlight],
div.nbinput div[class^=highlight] pre,
div.nboutput,
div.nboutput > div,
div.nboutput div[class^=highlight],
div.nboutput div[class^=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput > :first-child pre {
    color: navy;
}

/* output prompt */
div.nboutput > :first-child pre {
    color: darkred;
}

/* all prompts */
div.nbinput > :first-child[class^=highlight],
div.nboutput > :first-child[class^=highlight],
div.nboutput > :first-child {
    min-width: 11ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}

/* input/output area */
div.nbinput > :nth-child(2)[class^=highlight],
div.nboutput > :nth-child(2),
div.nboutput > :nth-child(2)[class^=highlight] {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
}

/* input area */
div.nbinput > :nth-child(2)[class^=highlight] {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput  > :nth-child(2).stderr {
    background: #fdd;
}

/* ANSI colors */
.ansiblack { color: black; }
.ansired { color: darkred; }
.ansigreen { color: darkgreen; }
.ansiyellow { color: #c4a000; }
.ansiblue { color: darkblue; }
.ansipurple { color: darkviolet; }
.ansicyan { color: steelblue; }
/* See https://github.com/jupyter/nbconvert/issues/174 */
.ansigray { color: gray; }  /* nbconvert CSS */
.ansigrey { color: gray; }  /* nbconvert HTML output */

.ansibgblack { background-color: black; }
.ansibgred { background-color: red; }
.ansibggreen { background-color: green; }
.ansibgyellow { background-color: yellow; }
.ansibgblue { background-color: blue; }
.ansibgpurple { background-color: magenta; }
.ansibgcyan { background-color: cyan; }
.ansibggray { background-color: gray; }

.ansibold { font-weight: bold; }
</style>
<div class="section" id="python-learning-journal-step-2">
<h1>Python Learning Journal: Step 2<a class="headerlink" href="#python-learning-journal-step-2" title="Permalink to this headline">¶</a></h1>
<p>In part one of this tutorial, you built the <em>data model</em> for a simple learning
journal web application using Pyramid, PostgreSQL, and SQLAlchemy. You deployed
this work to Heroku and confirmed that you could initialize a database and see
a simple page.</p>
<p>In this second part, you&#8217;ll build the <em>control layer</em> and the <em>view layer</em> for
this application. Along the way, you&#8217;ll learn about Test-Driven Development and
unit testing in Python using the <code class="docutils literal"><span class="pre">pytest</span></code> package.</p>
<p>Ready?  Let&#8217;s begin!</p>
<div class="section" id="preparing-to-work">
<h2>Preparing to Work<a class="headerlink" href="#preparing-to-work" title="Permalink to this headline">¶</a></h2>
<p>In part 1, you created a <em>virtualenv project</em> to work in.  The first step for
starting a new work day on the app will be to return to that environment:</p>
<div class="highlight-bash"><div class="highlight"><pre>cewing$ workon learning-journal
<span class="o">[</span>learning-journal<span class="o">]</span>
192:learning-journal cewing$
</pre></div>
</div>
<p>Next, you&#8217;ll want to make a new branch for the work in this part of the
tutorial:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span><span class="nv">master</span><span class="o">=]</span>
192:learning-journal cewing$ git checkout -b step2
Switched to a new branch <span class="s1">&#39;step2&#39;</span>
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2<span class="o">]</span>
192:learning-journal cewing$
</pre></div>
</div>
<p>You&#8217;ll do your work for this part of the tutorial in this branch, and then when
your tests are passing, merge it back to your <code class="docutils literal"><span class="pre">master</span></code> branch. Building this
habit ensures that your <code class="docutils literal"><span class="pre">master</span></code> branch always contains code that is
deployable.</p>
</div>
<div class="section" id="managing-db-connections">
<h2>Managing DB Connections<a class="headerlink" href="#managing-db-connections" title="Permalink to this headline">¶</a></h2>
<p>Before you go to far, a word or two about the circle of life.</p>
<div class="section" id="the-request-response-cycle">
<h3>The Request/Response Cycle<a class="headerlink" href="#the-request-response-cycle" title="Permalink to this headline">¶</a></h3>
<p>Every interaction in an HTTP-based system is bounded by the interchange of one
<em>request</em> and one <em>response</em>. No HTTP application can do anything until some
client makes a request. And no action by such an application is complete until
a response has been sent back to the client.</p>
<p>This is the lifecycle of an http web application.</p>
<p>In a data-driven application, the database is the memory store for the
application. It makes sense to bind the lifecycle of a database connection to
this same request/response cycle.</p>
<p>Pyramid does not dictate that you write an application that uses a database.
Because of this, managing the lifecycle of database connection so that they are
connected to the request/response cycle is up to you.</p>
<p>You could do this work manually, but happily there are add-ons available that
will take care of it on your behalf. You two of these in the first part of this
tutorial, <code class="docutils literal"><span class="pre">pyramid-tm</span></code>, or the Pyramid Transaction Manager, and
zope.sqlalchemy.</p>
<p>The purpose of pyramid-tm is to create a new <em>transaction</em> at the beginning of
each request, and to determine what to do with that transaction at the end,
before a response is returned to the client. By default, if there was any error
raised by code run during the request-response cycle, then the transaction is
rolled back. Otherwise, the transaction is committed.</p>
<p>The purpose of zope.sqlalchemy is to join the sqlalchemy database session to
this transaction manager.  This means that any code that reads from or writes
to the database will exist within a transaction that will be automatically
committed or rolled back.  You don&#8217;t need to worry about calling <code class="docutils literal"><span class="pre">commit</span></code> at
any time.</p>
</div>
<div class="section" id="adding-transaction-management">
<h3>Adding Transaction Management<a class="headerlink" href="#adding-transaction-management" title="Permalink to this headline">¶</a></h3>
<p>To use this transaction management there are a couple of updates you must make
to your code.</p>
<p>First, you need to create a database session that uses the
<code class="docutils literal"><span class="pre">ZopeTransactionExtension</span></code> from the <code class="docutils literal"><span class="pre">zope.sqlalchemy</span></code> package. Remember how
you created a session at the command line during class previously:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span> <span class="c1"># &lt;- import a factory maker</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>     <span class="c1"># &lt;- create a factory for sessions</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>                     <span class="c1"># &lt;- start a session</span>
</pre></div>
</div>
<p>In your journal app, you&#8217;ll do something quite similar, but you&#8217;ll use a
special kind of session called a <em>scoped_session</em> which helps to maintain the
association of one session with one request, even when there are many many
requests happening all at once.</p>
<p>In <code class="docutils literal"><span class="pre">journal.py</span></code> add the following code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c1"># add these imports at the top of the file</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">scoped_session</span><span class="p">,</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">zope.sqlalchemy</span> <span class="kn">import</span> <span class="n">ZopeTransactionExtension</span>

<span class="c1"># add this right below the imports</span>
<span class="n">DBSession</span> <span class="o">=</span> <span class="n">scoped_session</span><span class="p">(</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="n">ZopeTransactionExtension</span><span class="p">()))</span>
</pre></div>
</div>
<p>You&#8217;ve now bound a symbol at the module scope, one which is available to <em>all</em>
the code in your project, which is responsible for creating sessions for each
request.  This symbol will be your point of access to the database throughout
your appliation code.</p>
<p>Notice though that the session is not yet created. You&#8217;ve only created a
<em>factory</em> for making sessions. Nor does that factory know anything about which
database to connect to. Supplying that information is part of the job of
application configuration.</p>
<p>Remember in part one of this tutorial that you wrote a fully functional web
application. Part of that application code was a <em>factory function</em> responsible
for building and returning a configured app object to be served to clients.
That function is where the configuration of your application must happen, so
that function is where you will turn next.</p>
<p>Find the <code class="docutils literal"><span class="pre">main</span></code> function in <code class="docutils literal"><span class="pre">journal.py</span></code>.  at the moment it should look
like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create a configured wsgi app&quot;&quot;&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;reload_all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">debug</span>
    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;debug_all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">debug</span>
    <span class="c1"># configuration setup</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>
</div>
<p>Just below where you set <code class="docutils literal"><span class="pre">debug_all</span></code> in the setting dictionary, add the
following code to create the database engine and the set up the session
factory:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># ...</span>
    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;debug_all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">debug</span>          <span class="c1"># &lt;- already present, do not add</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TESTING&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="c1"># only bind the session if we are not testing</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">)</span>
        <span class="n">DBSession</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="c1"># configuration setup</span>
</pre></div>
</div>
<p>Finally, we&#8217;ll need to tell our application that we want to use the transaction
management provided by <code class="docutils literal"><span class="pre">pyramid-tm</span></code>. Pyramid allows add-ons to declare their
own configuration and allows you to simply include that configuration when you
want to use it. You do this using the <code class="docutils literal"><span class="pre">.include()</span></code> method of your
<code class="docutils literal"><span class="pre">Configurator</span></code> instance. Again, in <code class="docutils literal"><span class="pre">journal.py</span></code> add the following line,
just below where you bind <code class="docutils literal"><span class="pre">config</span></code> for the first time, and above where you
add your first <code class="docutils literal"><span class="pre">route</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># ...</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span>
        <span class="c1"># ...</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_tm&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>And that is all.  You&#8217;ve now created a session factory that will automatically
be thread-safe and local to a single request, and you&#8217;ve bound the lifecycle of
that session to a transaction that is started when a request arrives at your
application and closed when the response goes back to the client.</p>
<p>Now you want to prove that it works.</p>
</div>
</div>
<div class="section" id="setting-up-testing">
<h2>Setting Up Testing<a class="headerlink" href="#setting-up-testing" title="Permalink to this headline">¶</a></h2>
<p>In <a class="reference external" href="http://en.wikipedia.org/wiki/Test-driven_development,">Test Drive Development</a> you start by writing tests that demonstrate the
functionality you want to build. Once a test is written, you run it and see
that it fails. This proves that your application hasn&#8217;t sneakily already
provided that functionality and robbed you of a job. Then you implement the
code needed to make the test pass.</p>
<p>Before you can write tests, though, you&#8217;ll need to add a new package you&#8217;ll be
using to run your tests: <a class="reference external" href="http://pytest.org/latest/contents.html">pytest</a>.  In your terminal, with your
<code class="docutils literal"><span class="pre">learning-journal</span></code> virtualenv active, use <code class="docutils literal"><span class="pre">pip</span></code> to install <code class="docutils literal"><span class="pre">pytest</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2<span class="o">]</span>
192:learning-journal cewing$ pip install pytest
Downloading/unpacking pytest
  Downloading pytest-2.5.2.tar.gz <span class="o">(</span>608kB<span class="o">)</span>: 608kB downloaded
  Running setup.py <span class="o">(</span>path:/Users/cewing/virtualenvs/learning-journal/build/pytest/setup.py<span class="o">)</span> egg_info <span class="k">for</span> package pytest

  ...

Successfully installed pytest py
Cleaning up...
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2<span class="o">]</span>
192:learning-journal cewing$
</pre></div>
</div>
<p>Then, you&#8217;ll need to create a new file to hold your tests. Call it
<code class="docutils literal"><span class="pre">test_journal.py</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2<span class="o">]</span>
192:learning-journal cewing$ touch test_journal.py
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2<span class="o">]</span>
192:learning-journal cewing$
</pre></div>
</div>
<p>At this point, your project directory structure should look like this:</p>
<div class="highlight-python"><div class="highlight"><pre>.
├── .gitignore
├── LICENSE
├── Procfile
├── README.md
├── journal.py
├── requirements.txt
└── test_journal.py
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">pytest</span></code> module provides a new command, <code class="docutils literal"><span class="pre">py.test</span></code>.  When you execute
that command in your terminal, the package uses a standard heuristic to find
tests.</p>
<ul class="simple">
<li>It starts in the directory where the command is invoked.</li>
<li>It searches for Python files that start with <code class="docutils literal"><span class="pre">test_</span></code>.</li>
<li>It imports these files and finds functions that start with <code class="docutils literal"><span class="pre">test_</span></code>.</li>
<li>It executes those functions and reports the results.</li>
</ul>
<p>To begin, add the following code to your <code class="docutils literal"><span class="pre">test_journal.py</span></code> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>

<span class="n">TEST_DATABASE_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;postgresql://cewing:@localhost:5432/test-learning-journal&#39;</span>
<span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEST_DATABASE_URL</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span>

<span class="kn">import</span> <span class="nn">journal</span>
</pre></div>
</div>
<p>The order of things here looks odd, but it is very important. Make sure to
import your <code class="docutils literal"><span class="pre">journal</span></code> module last</p>
<p><strong>Notes</strong></p>
<ul class="simple">
<li>Remember to use <strong>the correct name for your database user</strong>, mine is just an
example.</li>
<li>Notice that you&#8217;ll be using a different <code class="docutils literal"><span class="pre">dbname</span></code> for testing. This prevents
overwriting data you might want to save.</li>
</ul>
<p>Take a moment to create that new database:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2<span class="o">]</span>
192:learning-journal cewing$ createdb test-learning-journal
</pre></div>
</div>
<div class="section" id="creating-fixtures">
<h3>Creating Fixtures<a class="headerlink" href="#creating-fixtures" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">pytest</span></code> module does more than just test discovery. It supports a concept
called <a class="reference external" href="http://pytest.org/latest/fixture.html">fixtures</a>.</p>
<p>Fixtures help you to manage resources needed for your tests. They are run
before and after your tests. You can use them to create and destroy resources
needed for testing. Fixtures help ensure that you have control over the
environment where your tests run.</p>
<p>You&#8217;ll add a few fixtures to help test your Pyramid app.</p>
<p>The first fixture is responsible for creating a connection to the database.  It
will be run once per testing session so that all tests use the same connection.</p>
<p>Add the following to <code class="docutils literal"><span class="pre">test_journal.py</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">TEST_DATABASE_URL</span><span class="p">)</span>
    <span class="n">journal</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">journal</span><span class="o">.</span><span class="n">DBSession</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">journal</span><span class="o">.</span><span class="n">DBSession</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>
    <span class="n">journal</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">engine</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">journal</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">connection</span>
</pre></div>
</div>
<p><strong>NOTES</strong>:</p>
<ul class="simple">
<li>The <code class="docutils literal"><span class="pre">pytest.fixture</span></code> decorator registers the <code class="docutils literal"><span class="pre">connection</span></code> function as a
fixture with pytest.</li>
<li>The <code class="docutils literal"><span class="pre">scope</span></code> argument passed to the decorator determines how often a fixture
is run.<ul>
<li><code class="docutils literal"><span class="pre">session</span></code> scope is run only once each time <code class="docutils literal"><span class="pre">py.test</span></code> is invoked.</li>
<li><code class="docutils literal"><span class="pre">module</span></code> scope is run once for each module of tests (once per Python
file).</li>
<li><code class="docutils literal"><span class="pre">function</span></code> scope is run once for each test function (this is the default).</li>
</ul>
</li>
<li>We&#8217;ll want to have the same connection across all tests, so scope this
fixture to <code class="docutils literal"><span class="pre">session</span></code>.</li>
<li>A fixture function may be defined with parameters.</li>
<li>The names of the parameters must match <em>registered fixtures</em>.</li>
<li>The fixtures named as parameters will be run surrounding the new fixture,
like the layers of an onion</li>
<li>The <code class="docutils literal"><span class="pre">request</span></code> parameter is a special fixture that <code class="docutils literal"><span class="pre">pytest</span></code> registers.</li>
<li>You use it to add a method that will be run after this fixture goes out of
scope using <code class="docutils literal"><span class="pre">.addfinalizer()</span></code></li>
<li>By returning <code class="docutils literal"><span class="pre">connection</span></code> from this fixture, tests or fixtures that depend on
it will be able to access the same connection created here.</li>
</ul>
<p>The next fixture we create will be responsible for providing us with a database
session we can use in our tests. Add the following to <code class="docutils literal"><span class="pre">test_journal.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@pytest.fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">db_session</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">transaction</span> <span class="kn">import</span> <span class="n">abort</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">rollback</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">abort</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">journal</span> <span class="kn">import</span> <span class="n">DBSession</span>
    <span class="k">return</span> <span class="n">DBSession</span>
</pre></div>
</div>
<p><strong>Notes</strong>:</p>
<ul class="simple">
<li>Notice that this fixture requires not only the <code class="docutils literal"><span class="pre">request</span></code> fixture provided
by pytest, but also the <code class="docutils literal"><span class="pre">connection</span></code> fixture you just wrote.</li>
<li>You start a new transaction here in this fixture, mocking the actions usually
handled by <code class="docutils literal"><span class="pre">pyramid-tm</span></code>.</li>
<li>You also add finalizers to rollback and then abort that transaction, which
ensure that no work in the database will persist between tests</li>
<li>This means that this fixture must be used for <em>each</em> test.  That is the
default scope so we do not designate a scope for this fixture.</li>
</ul>
</div>
</div>
<div class="section" id="writing-and-reading-entries">
<h2>Writing and Reading Entries<a class="headerlink" href="#writing-and-reading-entries" title="Permalink to this headline">¶</a></h2>
<p>Your journal&#8217;s <strong>data model</strong> consists of <em>entries</em>. You&#8217;ve set up a simple
database schema to represent them using a SQLAlchemy <code class="docutils literal"><span class="pre">model</span></code> class.</p>
<p>To write an entry, what would you need to do?</p>
<ul class="simple">
<li>Provide a title</li>
<li>Provide some body text</li>
<li>Write them to a row in the database</li>
</ul>
<p>This type of work is considered a <strong>controller</strong> because it connects client
input in the form of the title and text to the data model. The work should be
encapsulated in a function.  Moreover, to keep our application clean, it might
be a good idea to make this function a method of the <code class="docutils literal"><span class="pre">Entry</span></code> class you wrote
yesterday.  That way, the <code class="docutils literal"><span class="pre">Entry</span></code> class is responsible for writing new
entries. You probably don&#8217;t want to have to have an existing entry in order to
write a new one, so this would be a good job for a <em>class method</em>.</p>
<div class="section" id="test-writing-an-entry">
<h3>Test Writing An Entry<a class="headerlink" href="#test-writing-an-entry" title="Permalink to this headline">¶</a></h3>
<p>While you think a bit about how you might do that job, start by writing a test
that demonstrates the desired functionality. Often this can help you to think
more clearly about what such a method should do. In <code class="docutils literal"><span class="pre">test_journal.py</span></code>, add
the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_write_entry</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s2">&quot;Test Title&quot;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s2">&quot;Test entry text&quot;</span><span class="p">}</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_session</span>
    <span class="c1"># first, assert that there are no entries in the database:</span>
    <span class="k">assert</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">journal</span><span class="o">.</span><span class="n">Entry</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c1"># now, create an entry using the &#39;write&#39; class method</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="n">journal</span><span class="o">.</span><span class="n">Entry</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>NOTES</strong></p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">pytest</span></code> will only run functions that start with <code class="docutils literal"><span class="pre">test_</span></code> as tests.</li>
<li>You are passing <em>title</em>, <em>text</em>, <strong>and</strong> <em>session</em> to the <code class="docutils literal"><span class="pre">write</span></code> method.
That way you can be sure that the method uses the session you carefully
crafted in your fixture.</li>
</ul>
<p>Stop there for a moment.  What is going to happen when you run this test?</p>
<p>Try it out and see:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$ py.test --tb<span class="o">=</span><span class="nv">native</span>
<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==============================</span>
platform darwin -- Python 2.7.6 -- py-1.4.28 -- pytest-2.7.1
rootdir: /Users/cewing/projects/codefellows/learning-journal, inifile:
collected <span class="m">1</span> items

test_journal.py <span class="nv">F</span>

<span class="o">===================================</span> <span class="nv">FAILURES</span> <span class="o">===================================</span>
_______________________________ test_write_entry _______________________________
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;/Users/cewing/projects/codefellows/learning-journal/test_journal.py&quot;</span>, line 46, in test_write_entry
    <span class="nv">entry</span> <span class="o">=</span> journal.Entry.write<span class="o">(</span>**kwargs<span class="o">)</span>
AttributeError: <span class="nb">type</span> object <span class="s1">&#39;Entry&#39;</span> has no attribute <span class="s1">&#39;write&#39;</span>
<span class="o">===========================</span> <span class="m">1</span> failed in 0.27 <span class="nv">seconds</span> <span class="o">===========================</span>
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$
</pre></div>
</div>
<p>Yep.  As you probably expected, the test failed because there is no
<code class="docutils literal"><span class="pre">.write()</span></code> method on the Entry class.</p>
<p>Fix that problem by adding such a method, in the simplest possible form. You
don&#8217;t have to return anything from it for now, in fact, just make the method
body <code class="docutils literal"><span class="pre">pass</span></code>. Think about the test you just wrote, what does this method
expect as arguments? See if you can add a <code class="docutils literal"><span class="pre">.write()</span></code> method to your <code class="docutils literal"><span class="pre">Entry</span></code>
class in <code class="docutils literal"><span class="pre">journal.py</span></code>. Once you&#8217;ve finished, open my example below and
compare them.</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return

        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock10'))">Peek At A Solution</a><br /><div id="hiddencodeblock10" style="display: none"><div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Entry</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ... &lt;- column attributes are defined here</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div><p>Now, you should be able to run your previously written test, without causing an
error:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$ py.test --tb<span class="o">=</span><span class="nv">native</span>
<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==============================</span>
platform darwin -- Python 2.7.6 -- py-1.4.28 -- pytest-2.7.1
rootdir: /Users/cewing/projects/codefellows/learning-journal, inifile:
collected <span class="m">1</span> items

test_journal.py .

<span class="o">===========================</span> <span class="m">1</span> passed in 0.27 <span class="nv">seconds</span> <span class="o">===========================</span>
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$
</pre></div>
</div>
<p>Wonderful!  But does it actually test anything? Only that such a method exists.
Your tests should be a bit more sophisticated than this. Let&#8217;s add some
assertions about the outcome of calling <code class="docutils literal"><span class="pre">Entry.write()</span></code>.  Add the following
to <code class="docutils literal"><span class="pre">test_journal.py</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_write_entry</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span> <span class="c1"># &lt;- extend this test</span>

    <span class="c1"># ... &lt;- keep all the existing test content, just add the stuff below</span>

    <span class="c1"># the entry we get back ought to be an instance of Entry</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">journal</span><span class="o">.</span><span class="n">Entry</span><span class="p">)</span>
    <span class="c1"># id and created are generated automatically, but only on writing to</span>
    <span class="c1"># the database</span>
    <span class="n">auto_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">auto_fields</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span>
</pre></div>
</div>
<p>Now you&#8217;re making some assertions about what this method ought to do.  You are
saying that the method should return an <code class="docutils literal"><span class="pre">Entry</span></code> instance.  And that it should
have no &#8216;id&#8217; or &#8216;created&#8217; attributes at first.</p>
<p>Try running your tests again, and see what you get:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$ py.test --tb<span class="o">=</span><span class="nv">native</span>
<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==============================</span>
platform darwin -- Python 2.7.6 -- py-1.4.28 -- pytest-2.7.1
rootdir: /Users/cewing/projects/codefellows/learning-journal, inifile:
collected <span class="m">1</span> items

test_journal.py <span class="nv">F</span>

<span class="o">===================================</span> <span class="nv">FAILURES</span> <span class="o">===================================</span>
_______________________________ test_write_entry _______________________________
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;/Users/cewing/projects/codefellows/learning-journal/test_journal.py&quot;</span>, line 48, in test_write_entry
    assert isinstance<span class="o">(</span>entry, journal.Entry<span class="o">)</span>
AssertionError: assert isinstance<span class="o">(</span>None, &lt;class <span class="s1">&#39;journal.Entry&#39;</span>&gt;<span class="o">)</span>
 +  where &lt;class <span class="s1">&#39;journal.Entry&#39;</span>&gt; <span class="o">=</span> journal.Entry
<span class="o">===========================</span> <span class="m">1</span> failed in 0.27 <span class="nv">seconds</span> <span class="o">===========================</span>
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$
</pre></div>
</div>
<p>As expected, the test is failing again, because a new entry is <em>not</em> returned.
Let&#8217;s move to fix that by altering how our method works. Back in <code class="docutils literal"><span class="pre">journal.py</span></code>
change your method so that it creates and returns a new <code class="docutils literal"><span class="pre">Entry</span></code> object.</p>
<p>See if you can do this on your own.  Then check against my solution below:</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return

        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock11'))">Peek At A Solution</a><br /><div id="hiddencodeblock11" style="display: none"><div class="highlight-python"><div class="highlight"><pre><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">instance</span>
</pre></div>
</div>
</div><p>Okay, now run the tests again to see what happens.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$ py.test --tb<span class="o">=</span><span class="nv">native</span>
<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==============================</span>
platform darwin -- Python 2.7.6 -- py-1.4.28 -- pytest-2.7.1
rootdir: /Users/cewing/projects/codefellows/learning-journal, inifile:
collected <span class="m">1</span> items

test_journal.py .

<span class="o">===========================</span> <span class="m">1</span> passed in 0.27 <span class="nv">seconds</span> <span class="o">===========================</span>
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$
</pre></div>
</div>
<p>Terrific!  The test is passing again.  That&#8217;s wonderful.  But wait, we want our
method to write this new entry into the database so it will be persisted,
right? Are we testing for that yet? Let&#8217;s add a bit more and see what happens:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c1"># in test_journal.py</span>

<span class="k">def</span> <span class="nf">test_write_entry</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span> <span class="c1"># &lt;- extend this test</span>

    <span class="c1"># ... &lt;- keep all the existing test content, just add the stuff below</span>

    <span class="c1"># flush the session to &quot;write&quot; the data to the database</span>
    <span class="n">db_session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="c1"># now, we should have one entry:</span>
    <span class="k">assert</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">journal</span><span class="o">.</span><span class="n">Entry</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="o">!=</span> <span class="s1">&#39;session&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
    <span class="c1"># id and created should be set automatically upon writing to db:</span>
    <span class="k">for</span> <span class="n">auto</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">auto</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</pre></div>
</div>
<p>In your terminal, run the <code class="docutils literal"><span class="pre">py.test</span></code> command to see the expected failure:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$ py.test --tb<span class="o">=</span><span class="nv">native</span>
<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==============================</span>
platform darwin -- Python 2.7.6 -- py-1.4.28 -- pytest-2.7.1
rootdir: /Users/cewing/projects/codefellows/learning-journal, inifile:
collected <span class="m">1</span> items

test_journal.py <span class="nv">F</span>

<span class="o">===================================</span> <span class="nv">FAILURES</span> <span class="o">===================================</span>
_______________________________ test_write_entry _______________________________
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;/Users/cewing/projects/codefellows/learning-journal/test_journal.py&quot;</span>, line 57, in test_write_entry
    assert db_session.query<span class="o">(</span>journal.Entry<span class="o">)</span>.count<span class="o">()</span> <span class="o">==</span> 1
AssertionError: assert <span class="nv">0L</span> <span class="o">==</span> 1
 +  where <span class="nv">0L</span> <span class="o">=</span> &lt;bound method Query.count of &lt;sqlalchemy.orm.query.Query object at 0x10eae9dd0&gt;&gt;<span class="o">()</span>
 +    where &lt;bound method Query.count of &lt;sqlalchemy.orm.query.Query object at 0x10eae9dd0&gt;&gt; <span class="o">=</span> &lt;sqlalchemy.orm.query.Query object at 0x10eae9dd0&gt;.count
 +      where &lt;sqlalchemy.orm.query.Query object at 0x10eae9dd0&gt; <span class="o">=</span> &lt;bound method scoped_session.do of &lt;sqlalchemy.orm.scoping.scoped_session object at 0x10e75c750&gt;&gt;<span class="o">(</span>&lt;class <span class="s1">&#39;journal.Entry&#39;</span>&gt;<span class="o">)</span>
 +        where &lt;bound method scoped_session.do of &lt;sqlalchemy.orm.scoping.scoped_session object at 0x10e75c750&gt;&gt; <span class="o">=</span> &lt;sqlalchemy.orm.scoping.scoped_session object at 0x10e75c750&gt;.query
 +        and   &lt;class <span class="s1">&#39;journal.Entry&#39;</span>&gt; <span class="o">=</span> journal.Entry
<span class="o">===========================</span> <span class="m">1</span> failed in 0.27 <span class="nv">seconds</span> <span class="o">===========================</span>
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$
</pre></div>
</div>
<p>Alright.  Failing again.  This time because although you flushed your db
session, you got no entries back when you queried the database. It&#8217;s time to
wrap this up and write this entry to the database. Do you remember how we did
that during class? Try adding that to your <code class="docutils literal"><span class="pre">.write()</span></code> method. When you&#8217;re
done, check my solution below:</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return

        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock12'))">Peek At A Solution</a><br /><div id="hiddencodeblock12" style="display: none"><div class="highlight-python"><div class="highlight"><pre><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">DBSession</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">instance</span>
</pre></div>
</div>
</div><p>Now the purpose of passing the session becomes clear. If we don&#8217;t bother
passing one, then the <code class="docutils literal"><span class="pre">DBSession</span></code> defined in our <code class="docutils literal"><span class="pre">journal.py</span></code> file is used.
If we do pass one, then it is preferred. This allows the method to work both
here in tests, and in production where we don&#8217;t need (or want) to create a
special session.</p>
<p>Now, finally, run your test one last time and see it pass:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$ py.test --tb<span class="o">=</span><span class="nv">native</span>
<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==============================</span>
platform darwin -- Python 2.7.6 -- py-1.4.28 -- pytest-2.7.1
rootdir: /Users/cewing/projects/codefellows/learning-journal, inifile:
collected <span class="m">1</span> items

test_journal.py .

<span class="o">===========================</span> <span class="m">1</span> passed in 0.27 <span class="nv">seconds</span> <span class="o">===========================</span>
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$
</pre></div>
</div>
<p>You have a test that exercises this method and ensures that it does what is
supposed to do. And you have a method that makes the test pass. The
back-and-forth you&#8217;ve done is sometimes called <strong>Red-Green-Refactor</strong> in honor
of the colors of output in your terminal when you run the tests. It&#8217;s a great
way to iteratively develop functionality and at the same time ensure it is
tested properly.</p>
<p>What other tests might you implement here? Are there restrictions on the values
that ought to be placed in the database you wish to verify? How might you test
those restrictions?</p>
<p>Try your hand at writing a few tests of your own. Then you can peek at mine, if
you like:</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return

        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock13'))">Peek At A Solution</a><br /><div id="hiddencodeblock13" style="display: none"><div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_entry_no_title_fails</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="n">bad_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;test text&#39;</span><span class="p">}</span>
    <span class="n">journal</span><span class="o">.</span><span class="n">Entry</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">db_session</span><span class="p">,</span> <span class="o">**</span><span class="n">bad_data</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">):</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_entry_no_text_fails</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="n">bad_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;test title&#39;</span><span class="p">}</span>
    <span class="n">journal</span><span class="o">.</span><span class="n">Entry</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">db_session</span><span class="p">,</span> <span class="o">**</span><span class="n">bad_data</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">):</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</pre></div>
</div>
</div><p>Remember, when you are finished with this step, commit your changes to git so
you can preserve them.  Write a quality commit message explaining what you&#8217;ve
done and why.</p>
</div>
<div class="section" id="test-reading-entries">
<h3>Test Reading Entries<a class="headerlink" href="#test-reading-entries" title="Permalink to this headline">¶</a></h3>
<p>To read your journal, you&#8217;ll need a method that returns entries. For now, the
controller function can return all of them for a simple listing page. Your
specs:</p>
<ul class="simple">
<li>The return value should be a list of entries.</li>
<li>If there are no entries, the function should return an empty list.</li>
<li>The list should be ordered with the most recently created entries first.</li>
</ul>
<p>Again, begin with tests. Back in <code class="docutils literal"><span class="pre">test_journal.py</span></code> add the following code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_read_entries_empty</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">journal</span><span class="o">.</span><span class="n">Entry</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">test_read_entries_one</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="n">title_template</span> <span class="o">=</span> <span class="s2">&quot;Title {}&quot;</span>
    <span class="n">text_template</span> <span class="o">=</span> <span class="s2">&quot;Entry Text {}&quot;</span>
    <span class="c1"># write three entries, with order clear in the title and text</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">journal</span><span class="o">.</span><span class="n">Entry</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
            <span class="n">session</span><span class="o">=</span><span class="n">db_session</span><span class="p">)</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">journal</span><span class="o">.</span><span class="n">Entry</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span> <span class="o">&gt;</span> <span class="n">entries</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span> <span class="o">&gt;</span> <span class="n">entries</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">title</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">journal</span><span class="o">.</span><span class="n">Entry</span><span class="p">)</span>
</pre></div>
</div>
<p>What would you expect to be the result of running these tests now? Run your
tests to ensure that the two new tests fail in the way you expect. If you get a
different result that you expected, ask yourself why:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$ py.test --tb<span class="o">=</span><span class="nv">native</span>
<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==============================</span>
platform darwin -- Python 2.7.6 -- py-1.4.28 -- pytest-2.7.1
rootdir: /Users/cewing/projects/codefellows/learning-journal, inifile:
collected <span class="m">5</span> items

test_journal.py ...FF

<span class="o">===================================</span> <span class="nv">FAILURES</span> <span class="o">===================================</span>
___________________________ test_read_entries_empty ____________________________
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;/Users/cewing/projects/codefellows/learning-journal/test_journal.py&quot;</span>, line 80, in test_read_entries_empty
    <span class="nv">entries</span> <span class="o">=</span> journal.Entry.all<span class="o">()</span>
AttributeError: <span class="nb">type</span> object <span class="s1">&#39;Entry&#39;</span> has no attribute <span class="s1">&#39;all&#39;</span>
____________________________ test_read_entries_one _____________________________
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;/Users/cewing/projects/codefellows/learning-journal/test_journal.py&quot;</span>, line 94, in test_read_entries_one
    <span class="nv">entries</span> <span class="o">=</span> journal.Entry.all<span class="o">()</span>
AttributeError: <span class="nb">type</span> object <span class="s1">&#39;Entry&#39;</span> has no attribute <span class="s1">&#39;all&#39;</span>
<span class="o">======================</span> <span class="m">2</span> failed, <span class="m">3</span> passed in 0.27 <span class="nv">seconds</span> <span class="o">======================</span>
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$
</pre></div>
</div>
</div>
<div class="section" id="implement-entry-all">
<h3>Implement <code class="docutils literal"><span class="pre">Entry.all()</span></code><a class="headerlink" href="#implement-entry-all" title="Permalink to this headline">¶</a></h3>
<p>Now you are ready to implement the <strong>controller</strong> method that will make these
tests pass.  Look carefully at the tests you&#8217;ve written.  What do they tell you
about the method you need to write?</p>
<ul class="simple">
<li>It can take a database session as an optional argument</li>
<li>It is a class method (no instance created or used, right?)</li>
<li>It returns a list of things</li>
<li>Those things should be <code class="docutils literal"><span class="pre">Entry</span></code> instances</li>
</ul>
<p>Back in <code class="docutils literal"><span class="pre">journal.py</span></code> go ahead and work on implementing this function yourself.</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return

        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock14'))">Peek At A Solution</a><br /><div id="hiddencodeblock14" style="display: none"><div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Entry</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">DBSession</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</div><p><strong>NOTES</strong></p>
<ul class="simple">
<li>Again, we can optionally pass a session in order to allow for easier testing.</li>
<li>The simple query is now using an <code class="docutils literal"><span class="pre">order_by</span></code> clause to control the order in
which items are returned.</li>
<li>The argument to an <code class="docutils literal"><span class="pre">order_by</span></code> clause must be a <code class="docutils literal"><span class="pre">Column</span></code> instance</li>
<li><code class="docutils literal"><span class="pre">Column</span></code> instances have attributes that allow you to determine whether the
sort order is ascending or descending.</li>
</ul>
<p>Back in your terminal, your tests should now pass:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$ py.test --tb<span class="o">=</span><span class="nv">native</span>
<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==============================</span>
platform darwin -- Python 2.7.6 -- py-1.4.28 -- pytest-2.7.1
rootdir: /Users/cewing/projects/codefellows/learning-journal, inifile:
collected <span class="m">5</span> items

test_journal.py .....

<span class="o">===========================</span> <span class="m">5</span> passed in 0.31 <span class="nv">seconds</span> <span class="o">===========================</span>
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$
</pre></div>
</div>
</div>
<div class="section" id="where-we-stand">
<h3>Where We Stand<a class="headerlink" href="#where-we-stand" title="Permalink to this headline">¶</a></h3>
<p>You&#8217;ve now moved quite some distance in implementing your learning journal in
Pyramid.</p>
<ul class="simple">
<li>You&#8217;ve created a data model representing your entry</li>
<li>You&#8217;ve written code to initialize your database schema</li>
<li>You&#8217;ve put in place functions to write and read journal entries</li>
<li>And, since it&#8217;s tested, you are reasonably sure your code does what you think
it does.</li>
</ul>
<p>The next step will be to add a visible face to the journal.</p>
</div>
</div>
<div class="section" id="viewing-your-journal">
<h2>Viewing Your Journal<a class="headerlink" href="#viewing-your-journal" title="Permalink to this headline">¶</a></h2>
<p>The last step in the second part of this tutorial is to put a view on the front
page of this journal so we can see it online.</p>
<p>You&#8217;ll use <a class="reference external" href="http://jinja.pocoo.org/docs/templates/">the Jinja2 templating language</a> and connect your <em>controllers</em> to
the <em>views</em> that will display the data they expose.</p>
<div class="section" id="renderers-in-pyramid">
<h3>Renderers in Pyramid<a class="headerlink" href="#renderers-in-pyramid" title="Permalink to this headline">¶</a></h3>
<p>First, a detour into templates as they work in Pyramid.</p>
<p>Within the world of Pyramid, the data assembled by the <strong>controller</strong>s we
created above are passed off to a <em>renderer</em>.  A <em>renderer</em> is responsible for
taking that information, turning it into something that a client can use and
sending that off to be returned to the client. The data might be turned into an
HTML page, or a JSON response, or an XML document. For this reason, we consider
the <em>renderer</em> in Pyramid to fill the roll of the <strong>View</strong> in the <strong>MVC</strong>
pattern.</p>
</div>
<div class="section" id="installing-a-renderer-add-on">
<h3>Installing a Renderer Add-On<a class="headerlink" href="#installing-a-renderer-add-on" title="Permalink to this headline">¶</a></h3>
<p>Pyramid comes with a few simple renderers built-in: <code class="docutils literal"><span class="pre">'string'</span></code>, <code class="docutils literal"><span class="pre">'json'</span></code>,
and <code class="docutils literal"><span class="pre">'jsonp'</span></code>.  You can add new renderers by installing additional packages
and configuring them. We want to use <em>Jinja2 Templates</em> as renderers, and so we
are going to install <a class="reference external" href="http://docs.pylonsproject.org/projects/pyramid_jinja2/en/latest/">pyramid_jinja2</a>, which wraps the Jinja2 template
language in structures that Pyramid can use as renderers.</p>
<p>Begin by installing the package into your virtual environment:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2 *<span class="o">]</span>
192:learning-journal cewing$ pip install pyramid_jinja2
Downloading/unpacking pyramid-jinja2
...
Successfully installed pyramid-jinja2 Jinja2 markupsafe
Cleaning up...
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2 *<span class="o">]</span>
192:learning-journal cewing$
</pre></div>
</div>
<p>Once this is complete, add the dependency to your requirements.txt file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2 *<span class="o">]</span>
192:learning-journal cewing$ pip freeze &gt; requirements.txt
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2 *<span class="o">]</span>
192:learning-journal cewing$
</pre></div>
</div>
<p>That will ensure that Heroku will also be aware of these changes.</p>
<p>Finally, you&#8217;ll need to inform your application that it should use this new
renderer.  Pyramid handles this using configuration. Like with <code class="docutils literal"><span class="pre">pyramid-tm</span></code>,
<code class="docutils literal"><span class="pre">pyramid_jinja2</span></code> provides configuration that can be included by an
application that depends on it. You add this using the <code class="docutils literal"><span class="pre">include</span></code> method of
the config object.</p>
<p>In <code class="docutils literal"><span class="pre">journal.py</span></code> make the following change:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># ...</span>
    <span class="c1"># configuration setup</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_tm&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;pyramid_jinja2&#39;</span><span class="p">)</span>  <span class="c1"># &lt;-- ADD THIS LINE HERE</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will ensure that the configuration <code class="docutils literal"><span class="pre">pyramid_jinja2</span></code> requires to work
properly is in place.</p>
<p>Once you are done, commit your changes to <code class="docutils literal"><span class="pre">git</span></code> and make a good commit
message explaining what you&#8217;ve done and why.</p>
</div>
<div class="section" id="set-up-your-templates">
<h3>Set Up Your Templates<a class="headerlink" href="#set-up-your-templates" title="Permalink to this headline">¶</a></h3>
<p>Jinja2 templates use the concept of an <em>Environment</em> to:</p>
<ul class="simple">
<li>Figure out where to look for templates</li>
<li>Set configuration for the templating system</li>
<li>Add some commonly used functionality to the template <em>context</em></li>
</ul>
<p>Pyramid has a number of ways of working with this <em>environment</em> to assist in
finding templates.  The simplest to use (and the default in Pyramid) is
<a class="reference external" href="http://docs.pylonsproject.org/projects/pyramid-jinja2/en/latest/#caller-relative-template-lookup">caller-relative template lookup</a>.</p>
<p>In this scheme, templates are searched for in a path relative to the file in
which the calling code is found. Our entire application lives in a single file,
so we can establish a location adjacent to that file to hold our templates.</p>
<p>In your <code class="docutils literal"><span class="pre">learning-journal</span></code> repository, add a new <code class="docutils literal"><span class="pre">templates</span></code> directory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2<span class="o">]</span>
heffalump:learning-journal cewing$ mkdir templates
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2<span class="o">]</span>
heffalump:learning-journal cewing$
</pre></div>
</div>
<p>In this directory create a new file <code class="docutils literal"><span class="pre">base.jinja2</span></code>:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">&lt;html lang=&quot;en&quot;&gt;</span>
<span class="x">  &lt;head&gt;</span>
<span class="x">    &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="x">    &lt;title&gt;Python Learning Journal&lt;/title&gt;</span>
<span class="x">    &lt;!--[if lt IE 9]&gt;</span>
<span class="x">    &lt;script src=&quot;http://html5shiv.googlecode.com/svn/trunk/html5.js&quot;&gt;&lt;/script&gt;</span>
<span class="x">    &lt;![endif]--&gt;</span>
<span class="x">  &lt;/head&gt;</span>
<span class="x">  &lt;body&gt;</span>
<span class="x">    &lt;header&gt;</span>
<span class="x">      &lt;nav&gt;</span>
<span class="x">        &lt;ul&gt;</span>
<span class="x">          &lt;li&gt;&lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">        &lt;/ul&gt;</span>
<span class="x">      &lt;/nav&gt;</span>
<span class="x">    &lt;/header&gt;</span>
<span class="x">    &lt;main&gt;</span>
<span class="x">      &lt;h1&gt;My Python Journal&lt;/h1&gt;</span>
<span class="x">      &lt;section id=&quot;content&quot;&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;/section&gt;</span>
<span class="x">    &lt;/main&gt;</span>
<span class="x">    &lt;footer&gt;</span>
<span class="x">      &lt;p&gt;Created in the Code Fellows Python Dev Accelerator&lt;/p&gt;</span>
<span class="x">    &lt;/footer&gt;</span>
<span class="x">  &lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</div>
<p>This file represents the main structure of our website.  Individual pages will
be able to extend this structure through <em>template inheritance</em></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you have a layout for your learning journal you&#8217;d like to use, perhaps
the mockup you completed for pre-work, please feel free to use it here. You
may wish to begin by using my simple layout above, to minimize confusion
until you have the basics working.</p>
</div>
</div>
<div class="section" id="template-inheritance">
<h3>Template Inheritance<a class="headerlink" href="#template-inheritance" title="Permalink to this headline">¶</a></h3>
<p>Jinja2 allows you to combine templates in a number of different ways.</p>
<ul class="simple">
<li>you can make replaceable blocks in templates with <em>blocks</em>:<ul>
<li><code class="docutils literal"><span class="pre">{%</span> <span class="pre">block</span> <span class="pre">body</span> <span class="pre">%}{%</span> <span class="pre">endblock</span> <span class="pre">%}</span></code></li>
</ul>
</li>
<li>you can build on a template from within a second template by <em>extending</em>:<ul>
<li><code class="docutils literal"><span class="pre">{%</span> <span class="pre">extends</span> <span class="pre">&quot;base.jinja2&quot;</span> <span class="pre">%}</span></code></li>
<li>this <em>must</em> be the first text in the template</li>
</ul>
</li>
<li>you can re-use common structure with <em>include</em>:<ul>
<li><code class="docutils literal"><span class="pre">{%</span> <span class="pre">include</span> <span class="pre">&quot;footer.jinja2&quot;</span> <span class="pre">%}</span></code></li>
</ul>
</li>
</ul>
<p>In our <code class="docutils literal"><span class="pre">base.jinja2</span></code> we added a <code class="docutils literal"><span class="pre">block</span></code> called body.  Now we can create a
template that will extend that.</p>
</div>
<div class="section" id="displaying-an-entries-list">
<h3>Displaying an Entries List<a class="headerlink" href="#displaying-an-entries-list" title="Permalink to this headline">¶</a></h3>
<p>Keep it simple for now, create a new file, <code class="docutils literal"><span class="pre">list.jinja2</span></code> in <code class="docutils literal"><span class="pre">templates</span></code>.
This will <em>extend</em> your <code class="docutils literal"><span class="pre">base.jinja2</span></code> file, filling the <em>body</em> block in that
template:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.jinja2&quot;</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  &lt;h2&gt;Entries&lt;/h2&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">entry</span> <span class="k">in</span> <span class="nv">entries</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  &lt;article class=&quot;entry&quot; id=&quot;entry=</span><span class="cp">{{</span><span class="nv">entry.id</span><span class="cp">}}</span><span class="x">&quot;&gt;</span>
<span class="x">    &lt;h3&gt;</span><span class="cp">{{</span> <span class="nv">entry.title</span> <span class="cp">}}</span><span class="x">&lt;/h3&gt;</span>
<span class="x">    &lt;p class=&quot;dateline&quot;&gt;</span><span class="cp">{{</span> <span class="nv">entry.created.strftime</span><span class="o">(</span><span class="s1">&#39;%b. %d, %Y&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">    &lt;div class=&quot;entry_body&quot;&gt;</span>
<span class="x">      </span><span class="cp">{{</span> <span class="nv">entry.text</span><span class="o">|</span><span class="nf">safe</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">  &lt;/article&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  &lt;div class=&quot;entry&quot;&gt;</span>
<span class="x">    &lt;p&gt;&lt;em&gt;No entries here so far&lt;/em&gt;&lt;/p&gt;</span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p>Notice that because of <em>caller-relative template lookup</em> we refer to the
<code class="docutils literal"><span class="pre">base.jinja2</span></code> file without any directory reference.  Both that file and this
<code class="docutils literal"><span class="pre">list.jinja2</span></code> file are in the same location so a relative lookup only needs
the filename.</p>
<p>The template will loop over a set of <code class="docutils literal"><span class="pre">entries</span></code>, showing each in an HTML5
<code class="docutils literal"><span class="pre">&lt;article/&gt;</span></code> tag.</p>
<p>At this point, your project directory should look like this:</p>
<div class="highlight-python"><div class="highlight"><pre>.
├── .gitignore
├── LICENSE
├── Procfile
├── README.md
├── journal.py
├── requirements.txt
├── templates
│   ├── base.jinja2
│   └── list.jinja2
└── test_journal.py
</pre></div>
</div>
<p>This template we&#8217;ve just created will be a Pyramid <em>renderer</em>.  We&#8217;ve noted
that the <em>renderer</em> in Pyramid takes the <em>view</em> role in the <em>MVC</em> pattern. What
remains for us to do is to connect the <em>controller</em> functions to these new
<em>renderers</em> we are creating so that we can see the results of our hard work.</p>
</div>
<div class="section" id="test-viewing-entries">
<h3>Test Viewing Entries<a class="headerlink" href="#test-viewing-entries" title="Permalink to this headline">¶</a></h3>
<p>Before we test viewing entries, we must first talk about different types of
tests.</p>
<p>The tests we&#8217;ve written so far are what you can call <em>unit tests</em>.  They
concentrate on small, simple functionality and <em>mock</em> or make up any
environment they require to function. <em>Unit tests</em> are designed to test
functions in isolation from a real system to ensure that they operate as
intended on their own.</p>
<p>The new tests we are going to write are <em>functional</em> tests.  They will require
that we engage all of Pyramid&#8217;s functionality so that we can request a web page
and make assertions about the content that is returned to us.</p>
<p>To write functional tests we&#8217;ll need to add a new dependency on a package
called <a class="reference external" href="http://webtest.pythonpaste.org/en/latest/index.html">WebTest</a>.  This package will set up a complete <em>WSGI</em> application and
provide us with machinery we can use to interact with it.</p>
<p>Begin by installing <code class="docutils literal"><span class="pre">WebTest</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2<span class="o">]</span>
heffalump:learning-journal cewing$ pip install WebTest
...
Cleaning up...
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2 *<span class="o">]</span>
heffalump:learning-journal cewing$
</pre></div>
</div>
<p>Next, we will have to create a <em>pytest fixture</em> that will set everything up for
us:</p>
<ul class="simple">
<li>The fixture will need to create a configured application</li>
<li>The fixture will need to wrap that application in the WebTest server</li>
<li>The fixture will return the wrapped application so tests can use it</li>
<li>The fixture should be run for each test so that you get a fresh instance of
the application each time</li>
</ul>
<p>Between the WebTest documentation and code you&#8217;ve already written, you can try
writing this new fixture on your own.</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return

        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock15'))">Peek At A Solution</a><br /><div id="hiddencodeblock15" style="display: none"><div class="highlight-python"><div class="highlight"><pre><span class="nd">@pytest.fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">app</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">journal</span> <span class="kn">import</span> <span class="n">main</span>
    <span class="kn">from</span> <span class="nn">webtest</span> <span class="kn">import</span> <span class="n">TestApp</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">main</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">TestApp</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
</div><p>Now that we have a fixture that will provide us with a functional app we can
interact with, we can write our first tests for the view of a list of entries.
Add the following to <code class="docutils literal"><span class="pre">test_journal.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_empty_listing</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;No entries here so far&#39;</span>
    <span class="k">assert</span> <span class="n">expected</span> <span class="ow">in</span> <span class="n">actual</span>
</pre></div>
</div>
<p><strong>NOTES</strong></p>
<ul class="simple">
<li>The <code class="docutils literal"><span class="pre">app</span></code> created by our fixture works as a mock HTTP client, like a web
browser for us to use.</li>
<li>The <code class="docutils literal"><span class="pre">data</span></code> attribute of the <em>response</em> returned by <code class="docutils literal"><span class="pre">client.get()</span></code> holds
the full rendered HTML of our page, but we are only checking for the one
thing we want to see.</li>
</ul>
<p>Next, you&#8217;ll test what happens when you have some entries. But to do so, you&#8217;ll
need to create entries. The simplest solution is to write the entry and commit
it, then delete it when the test is over.</p>
<p>Try your hand at writing a <code class="docutils literal"><span class="pre">function</span></code> scoped fixture that will take care of
this for you. It&#8217;d be quite nice if it would return information about the entry
it writes as well, so you can use it to test against:</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return

        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock16'))">Peek At A Solution</a><br /><div id="hiddencodeblock16" style="display: none"><div class="highlight-python"><div class="highlight"><pre><span class="nd">@pytest.fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">entry</span><span class="p">(</span><span class="n">db_session</span><span class="p">):</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="n">journal</span><span class="o">.</span><span class="n">Entry</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Test Title&#39;</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Test Entry Text&#39;</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="n">db_session</span>
    <span class="p">)</span>
    <span class="n">db_session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">entry</span>
</pre></div>
</div>
</div><p>Now, use this new fixture in a test of retrieving a listing of entries.  See if
you can write this test yourself:</p>
<script type="text/javascript">
    function showhide(element){
        if (!document.getElementById)
            return

        if (element.style.display == "block")
            element.style.display = "none"
        else
            element.style.display = "block"
    };
</script>
<a href="javascript:showhide(document.getElementById('hiddencodeblock17'))">Peek At A Solution</a><br /><div id="hiddencodeblock17" style="display: none"><div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_listing</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">]:</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="s1">&#39;absent&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">expected</span> <span class="ow">in</span> <span class="n">actual</span>
</pre></div>
</div>
</div><p>If you run your tests with these two new tests added, you should see both fail:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$ py.test --tb<span class="o">=</span><span class="nv">native</span>
<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==============================</span>
platform darwin -- Python 2.7.6 -- py-1.4.28 -- pytest-2.7.1
rootdir: /Users/cewing/projects/codefellows/learning-journal, inifile:
collected <span class="m">7</span> items

test_journal.py .....FF

<span class="o">===================================</span> <span class="nv">FAILURES</span> <span class="o">===================================</span>
______________________________ test_empty_listing ______________________________
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;/Users/cewing/projects/codefellows/learning-journal/test_journal.py&quot;</span>, line 124, in test_empty_listing
    assert expected in actual
AssertionError: assert <span class="s1">&#39;No entries here so far&#39;</span> in <span class="s1">&#39;Hello World&#39;</span>
_________________________________ test_listing _________________________________
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;/Users/cewing/projects/codefellows/learning-journal/test_journal.py&quot;</span>, line 133, in test_listing
    assert expected in actual
AssertionError: assert <span class="s1">&#39;Test Title&#39;</span> in <span class="s1">&#39;Hello World&#39;</span>
<span class="o">======================</span> <span class="m">2</span> failed, <span class="m">5</span> passed in 0.37 <span class="nv">seconds</span> <span class="o">======================</span>
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$
</pre></div>
</div>
</div>
<div class="section" id="writing-the-list-view">
<h3>Writing the List View<a class="headerlink" href="#writing-the-list-view" title="Permalink to this headline">¶</a></h3>
<p>Interesting. Your tests fail, but not because you haven&#8217;t implemented a
function yet. Instead they fail because there <em>is</em> a function found that is
returning the wrong thing: &#8220;Hello World&#8221;</p>
<p>This brings us to the topic of how Pyramid serves HTTP requests.</p>
<p>Every time a client requests a page from your Pyramid app (and this is what
happens when you call the <code class="docutils literal"><span class="pre">get</span></code> method of your <code class="docutils literal"><span class="pre">app</span></code>) a process happens.</p>
<p><strong>Matching a Route</strong></p>
<p>The first step is that Pyramid looks for <em>routes</em> that have been configured and
tries to match one to the <em>path</em> of the request from the client. At this point,
you may say &#8220;But I never made any routes, I don&#8217;t even know what one is&#8221;.
You&#8217;d be at least partly wrong.</p>
<p>In the first step of our application, when you created the <code class="docutils literal"><span class="pre">main</span></code> function,
you included this line of configuration:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>That code configures a single <em>route</em>.  The route has a <em>name</em> (<code class="docutils literal"><span class="pre">'home'</span></code>) and
a <em>pattern</em> (<code class="docutils literal"><span class="pre">'/'</span></code>). Pyramid tries to match the <em>path</em> of an incoming request
to that pattern.  Our tests both have this line of code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>That line uses the app as a mock web browser to make a <code class="docutils literal"><span class="pre">GET</span></code> request for the
path <code class="docutils literal"><span class="pre">'/'</span></code>!  This path matches the pattern for our <code class="docutils literal"><span class="pre">'home'</span></code> route, and so
that&#8217;s the route that is selected.</p>
<p><strong>Selecting a View</strong></p>
<p>Once a <em>route</em> has been selected, the next step Pyramid takes is to select a
<em>view</em> that is configured to use that route. Again, you might think you have no
idea what a <em>view</em> is in Pyramid, but actually, you wrote one of these in the
first step of this tutorial as well:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;Hello World&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">view_config</span></code> decorator is used by Pyramid to decorate some function that
can serve as a <em>view function</em>.  The sole hard-and-fast requirement of a view
function is that it take <code class="docutils literal"><span class="pre">request</span></code> as an argument.</p>
<p>The <code class="docutils literal"><span class="pre">view_config</span></code> decorator can take a number of arguments. One that you must
provide is <code class="docutils literal"><span class="pre">route_name</span></code>. This parameter serves to connect a <em>view function</em>
to a <em>route</em>.</p>
<p>When Pyramid matches the <code class="docutils literal"><span class="pre">'home'</span></code> route, it then seeks a view function that
is configured with that <em>route_name</em>. This <code class="docutils literal"><span class="pre">home</span></code> function is found, and it
is executed.</p>
<p><strong>Rendering a Response</strong></p>
<p>After the view is executed, the return value of the function is passed on to
any <em>renderer</em> configured by the <code class="docutils literal"><span class="pre">view_config</span></code> decorator.  That <em>renderer</em> is
responsible for turning the data from the <em>view function</em> into a response
suitable for sending back to a client.  In this case, the <code class="docutils literal"><span class="pre">'string'</span></code> renderer
takes whatever value is returned by the <em>view function</em> and sends it back to
the client as a plain text response.  This is why your test sees the body of
the response as &#8220;Hello World&#8221;!</p>
<p>For <em>template renderers</em>, like the one you&#8217;ve just created, a view is required
to return a dict instance that can serve as context for the template. This
means that any symbols used in the template must be present in the dict
returned by the view.</p>
<p>Notice that your list view template contains one symbol that isn&#8217;t defined in
the scope of the template itself:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">for</span> <span class="nv">entry</span> <span class="k">in</span> <span class="nv">entries</span> <span class="cp">%}</span><span class="x"></span>
<span class="x"> ...</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x"></span>
<span class="x"> ...</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p>Somehow, you&#8217;ll need to provide a dictionary with the key <cite>entries</cite> in it to
this template <em>renderer</em>.</p>
<p>A view <em>can</em> be configured without a <em>renderer</em>.  If this is the case, the view
itself is responsible for returning a value suitable for returning to the
client.  We will see an example of this later.</p>
</div>
<div class="section" id="a-word-on-terminology">
<h3>A Word on Terminology<a class="headerlink" href="#a-word-on-terminology" title="Permalink to this headline">¶</a></h3>
<p>Although the MVC pattern is a useful abstraction, it&#8217;s not a perfect match for
the web world. There are a few differences in how things are named in Python
web frameworks, and a few ambiguities about where the edges are:</p>
<table border="1" class="centered width-80 docutils">
<colgroup>
<col width="43%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">MVC Terminology</th>
<th class="head">Python Web Frameworks</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Model</td>
<td>Model</td>
</tr>
<tr class="row-odd"><td>Conroller</td>
<td><ul class="first last simple">
<li>View Function</li>
<li>Class Based View</li>
<li>Model methods</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>View</td>
<td><ul class="first last simple">
<li>Renderer</li>
<li>Template</li>
<li>View Function</li>
<li>Class Based View</li>
<li>HTTP Response</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Note in particular that what <em>MVC</em> calls a <em>controller</em> is most directly
analogous to what Python calls a <em>view</em>. This will be a source of confusion, so
I will try to use the term <em>view function</em> to be more precise.</p>
<p>For more on this difference and why it exists, you can <a class="reference external" href="http://docs.pylonsproject.org/projects/pyramid/en/latest/designdefense.html#pyramid-gets-its-terminology-wrong-mvc">read this</a> from the
Pyramid design documentation.</p>
</div>
<div class="section" id="a-visual-exploration">
<h3>A Visual Exploration<a class="headerlink" href="#a-visual-exploration" title="Permalink to this headline">¶</a></h3>
<p>It&#8217;s easiest to see the effects of this chain of operations by using a real
browser.</p>
<p>Take a moment to start up your application at the command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>step2 *<span class="o">]</span>
heffalump:learning-journal cewing$ python journal.py
serving on http://0.0.0.0:5000
</pre></div>
</div>
<p>When it&#8217;s running, point your web browser at this address:</p>
<p><a class="reference external" href="http://localhost:5000">http://localhost:5000</a></p>
<p>You should see something like this:</p>
<img alt="../../_images/flask_hello.png" class="align-center" src="../../_images/flask_hello.png" />
<p>Now, quit your application with <code class="docutils literal"><span class="pre">^C</span></code> (that&#8217;s the <em>control</em> key and the letter
<em>c</em>). Then remove the following code from your <code class="docutils literal"><span class="pre">journal.py</span></code> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;Hello World&quot;</span>
</pre></div>
</div>
<p>Restart your application as you did before.  Reload the same URL and you should
see this:</p>
<img alt="../../_images/pyramid_not_found.png" class="align-center" src="../../_images/pyramid_not_found.png" />
<p>If a matched <em>route</em> has no <em>view</em> to pass the request to, it will raise a
<strong>404</strong> error.</p>
<p>Now, let&#8217;s re-connect the <code class="docutils literal"><span class="pre">'home'</span></code> route to a <em>view function</em>. We need to create a
function that will take the <code class="docutils literal"><span class="pre">request</span></code> as an argument and will return a</p>
<p>Make the following changes to <code class="docutils literal"><span class="pre">journal.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;templates/list.jinja2&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">list_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;entries&#39;</span><span class="p">:</span> <span class="n">entries</span><span class="p">}</span>
</pre></div>
</div>
<p>Finally, having saved this change, restart your application and again load the
URL:</p>
<p><a class="reference external" href="http://localhost:5000">http://localhost:5000</a></p>
<p>You should see something like this:</p>
<img alt="../../_images/pyramid_list_page_nostyle.png" class="align-center" src="../../_images/pyramid_list_page_nostyle.png" />
<p>You&#8217;ve now attached the <code class="docutils literal"><span class="pre">'home'</span></code> route to the <code class="docutils literal"><span class="pre">read_entries</span></code> function,
making it a <em>view</em> function. And you&#8217;ve configured it to use the
<code class="docutils literal"><span class="pre">list.jinja2</span></code> <em>renderer</em> we created earlier. Review that template. Make sure
you understand why the page is appearing with &#8220;<em>No entries here so far</em>&#8221;.</p>
<p>Quit your application again and now all your tests should pass:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$ py.test --tb<span class="o">=</span><span class="nv">native</span>
<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==============================</span>
platform darwin -- Python 2.7.6 -- py-1.4.28 -- pytest-2.7.1
rootdir: /Users/cewing/projects/codefellows/learning-journal, inifile:
collected <span class="m">7</span> items

test_journal.py .......

<span class="o">===========================</span> <span class="m">7</span> passed in 0.38 <span class="nv">seconds</span> <span class="o">===========================</span>
<span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>pyramid/step2 *<span class="o">]</span>
Pratchett:learning-journal cewing$
</pre></div>
</div>
</div>
</div>
<div class="section" id="deploying-your-work">
<h2>Deploying Your Work<a class="headerlink" href="#deploying-your-work" title="Permalink to this headline">¶</a></h2>
<p>It&#8217;s no fun to do all this work without seeing what you&#8217;ve done.</p>
<p>Repeat the steps you performed for the previous assignment to submit your work
and prepare for deployment. As a reminder, here&#8217;s the outline:</p>
<ol class="arabic simple">
<li>push all local work on the <code class="docutils literal"><span class="pre">step2</span></code> branch up to GitHub</li>
<li>create a pull request in your GitHub repository from <code class="docutils literal"><span class="pre">step2</span></code> to
<code class="docutils literal"><span class="pre">master</span></code></li>
<li>copy the URL for that pull request and submit your assignment in Canvas</li>
<li>locally, checkout <code class="docutils literal"><span class="pre">master</span></code> and merge your work from <code class="docutils literal"><span class="pre">step2</span></code> (remember,
this will close your pull request, but that&#8217;s fine)</li>
<li>push master to the heroku remote</li>
</ol>
<div class="section" id="create-an-entry-on-heroku">
<h3>Create an Entry on Heroku<a class="headerlink" href="#create-an-entry-on-heroku" title="Permalink to this headline">¶</a></h3>
<p>You really do want to see your first journal entry, don&#8217;t you?</p>
<p>Go ahead and create one. Start by opening a python session with Heroku:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span><span class="nv">master</span><span class="o">=]</span>
192:learning-journal cewing$ heroku run python
Running <span class="sb">`</span>python<span class="sb">`</span> attached to terminal... up, run.9416
Python 2.7.6 <span class="o">(</span>default, Jan <span class="m">16</span> 2014, 02:39:37<span class="o">)</span>
<span class="o">[</span>GCC 4.4.3<span class="o">]</span> on linux2
Type <span class="s2">&quot;help&quot;</span>, <span class="s2">&quot;copyright&quot;</span>, <span class="s2">&quot;credits&quot;</span> or <span class="s2">&quot;license&quot;</span> <span class="k">for</span> more information.
&gt;&gt;&gt;
</pre></div>
</div>
<p>And now, create a first entry:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">journal</span> <span class="kn">import</span> <span class="n">Entry</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">db_url</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span>
<span class="gp">... </span>  <span class="n">title</span><span class="o">=</span><span class="s2">&quot;My First Entry&quot;</span><span class="p">,</span>
<span class="gp">... </span>  <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Today I learned you can write a journal entry from the command line in Heroku,  Neat!&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>Once you&#8217;re done, use the standard <code class="docutils literal"><span class="pre">^D</span></code> to detach from the Python terminal on
Heroku. At this point you are good to go. Well done!</p>
<p>At this point, you should actually be able to see your website running on
Heroku. You can open a browser and point immediately to the site using a
command from the Heroku toolbelt:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span><span class="nv">master</span><span class="o">=]</span>
heffalump:learning-journal cewing$ heroku open
Opening evening-brushlands-7955... <span class="k">done</span>
</pre></div>
</div>
<p>Your browser should then open (or open a new tab) and you should see something
a bit like this:</p>
<a class="reference internal image-reference" href="../../_images/lj_heroku.png"><img alt="../../_images/lj_heroku.png" src="../../_images/lj_heroku.png" style="width: 90%;" /></a>
<p>If you see an error instead, here are some tools to use in debugging:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span><span class="nv">master</span><span class="o">=]</span>
heffalump:learning-journal cewing$ heroku ps
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">ps</span></code> command should tell you if there are any <em>dynos</em> running.  You
should see output like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>master<span class="o">]</span>
heffalump:learning-journal cewing$ heroku <span class="nv">ps</span>
<span class="o">===</span> web <span class="o">(</span>1X<span class="o">)</span>: <span class="sb">`</span>python journal.py<span class="sb">`</span>
web.1: up 2015/01/28 19:28:17 <span class="o">(</span>~ 2s ago<span class="o">)</span>
</pre></div>
</div>
<p>If you see nothing instead you can use the <code class="docutils literal"><span class="pre">scale</span></code> command to start a new
<em>dyno</em>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>master<span class="o">]</span>
heffalump:learning-journal cewing$ heroku scale <span class="nv">web</span><span class="o">=</span>1
Scaling dynos... <span class="k">done</span>, now running web at 1:1X.
</pre></div>
</div>
<p>You can also use the <code class="docutils literal"><span class="pre">scale</span></code> command to turn your website off.  Just scale
<code class="docutils literal"><span class="pre">web=0</span></code>.</p>
<p>If you get messages saying that your application crashed when you run <code class="docutils literal"><span class="pre">ps</span></code>,
or if you see &#8220;internal server error&#8221; messages in your browser indicating
something is wrong with the code in your application, you can use the heroku
<code class="docutils literal"><span class="pre">logs</span></code> command to see logfiles of the server:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span>master<span class="o">]</span>
heffalump:learning-journal cewing$ heroku logs
2015-01-26T04:30:17.767423+00:00 heroku<span class="o">[</span>api<span class="o">]</span>: Enable Logplex by c...
2015-01-26T04:30:17.767423+00:00 heroku<span class="o">[</span>api<span class="o">]</span>: Release v2 created by c...
...
</pre></div>
</div>
<p>These log messages may be quite cryptic, but they will help you to debug
problems if you read them carefully.</p>
<p>Finally, remember that to help yourself figure out what is happening, you can
always open a Python interpreter in the Heroku environment:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>learning-journal<span class="o">]</span>
<span class="o">[</span><span class="nv">master</span><span class="o">=]</span>
192:learning-journal cewing$ heroku run python
Running <span class="sb">`</span>python<span class="sb">`</span> attached to terminal... up, run.9416
Python 2.7.6 <span class="o">(</span>default, Jan <span class="m">16</span> 2014, 02:39:37<span class="o">)</span>
<span class="o">[</span>GCC 4.4.3<span class="o">]</span> on linux2
Type <span class="s2">&quot;help&quot;</span>, <span class="s2">&quot;copyright&quot;</span>, <span class="s2">&quot;credits&quot;</span> or <span class="s2">&quot;license&quot;</span> <span class="k">for</span> more information.
&gt;&gt;&gt;
</pre></div>
</div>
<p>From there you can poke around at your journal code to see what might be wrong.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Python Learning Journal: Step 2</a><ul>
<li><a class="reference internal" href="#preparing-to-work">Preparing to Work</a></li>
<li><a class="reference internal" href="#managing-db-connections">Managing DB Connections</a><ul>
<li><a class="reference internal" href="#the-request-response-cycle">The Request/Response Cycle</a></li>
<li><a class="reference internal" href="#adding-transaction-management">Adding Transaction Management</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-up-testing">Setting Up Testing</a><ul>
<li><a class="reference internal" href="#creating-fixtures">Creating Fixtures</a></li>
</ul>
</li>
<li><a class="reference internal" href="#writing-and-reading-entries">Writing and Reading Entries</a><ul>
<li><a class="reference internal" href="#test-writing-an-entry">Test Writing An Entry</a></li>
<li><a class="reference internal" href="#test-reading-entries">Test Reading Entries</a></li>
<li><a class="reference internal" href="#implement-entry-all">Implement <code class="docutils literal"><span class="pre">Entry.all()</span></code></a></li>
<li><a class="reference internal" href="#where-we-stand">Where We Stand</a></li>
</ul>
</li>
<li><a class="reference internal" href="#viewing-your-journal">Viewing Your Journal</a><ul>
<li><a class="reference internal" href="#renderers-in-pyramid">Renderers in Pyramid</a></li>
<li><a class="reference internal" href="#installing-a-renderer-add-on">Installing a Renderer Add-On</a></li>
<li><a class="reference internal" href="#set-up-your-templates">Set Up Your Templates</a></li>
<li><a class="reference internal" href="#template-inheritance">Template Inheritance</a></li>
<li><a class="reference internal" href="#displaying-an-entries-list">Displaying an Entries List</a></li>
<li><a class="reference internal" href="#test-viewing-entries">Test Viewing Entries</a></li>
<li><a class="reference internal" href="#writing-the-list-view">Writing the List View</a></li>
<li><a class="reference internal" href="#a-word-on-terminology">A Word on Terminology</a></li>
<li><a class="reference internal" href="#a-visual-exploration">A Visual Exploration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deploying-your-work">Deploying Your Work</a><ul>
<li><a class="reference internal" href="#create-an-entry-on-heroku">Create an Entry on Heroku</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Python 401 2.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014-2016, Cris Ewing, Nicholas Hunt-Walker.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
  </body>
</html>