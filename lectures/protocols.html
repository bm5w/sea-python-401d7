<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Network Protocols in Python &mdash; Python 401 2.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Python 401 2.1 documentation" href="../index.html" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />

<link rel="stylesheet" href="../_static/custom.css" type="text/css" media="screen" charset="utf-8" />

<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head>
  <body role="document">
<div class="header">
  <div class="logo">
    <a href="../index.html">
      <img class="logo" src="../_static/cf_logo.png" alt="Logo"/>
      <p>Code Fellows</p>
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">Python 401 2.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput > div,
div.nbinput div[class^=highlight],
div.nbinput div[class^=highlight] pre,
div.nboutput,
div.nboutput > div,
div.nboutput div[class^=highlight],
div.nboutput div[class^=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput > :first-child pre {
    color: navy;
}

/* output prompt */
div.nboutput > :first-child pre {
    color: darkred;
}

/* all prompts */
div.nbinput > :first-child[class^=highlight],
div.nboutput > :first-child[class^=highlight],
div.nboutput > :first-child {
    min-width: 11ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}

/* input/output area */
div.nbinput > :nth-child(2)[class^=highlight],
div.nboutput > :nth-child(2),
div.nboutput > :nth-child(2)[class^=highlight] {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
}

/* input area */
div.nbinput > :nth-child(2)[class^=highlight] {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput  > :nth-child(2).stderr {
    background: #fdd;
}

/* ANSI colors */
.ansiblack { color: black; }
.ansired { color: darkred; }
.ansigreen { color: darkgreen; }
.ansiyellow { color: #c4a000; }
.ansiblue { color: darkblue; }
.ansipurple { color: darkviolet; }
.ansicyan { color: steelblue; }
/* See https://github.com/jupyter/nbconvert/issues/174 */
.ansigray { color: gray; }  /* nbconvert CSS */
.ansigrey { color: gray; }  /* nbconvert HTML output */

.ansibgblack { background-color: black; }
.ansibgred { background-color: red; }
.ansibggreen { background-color: green; }
.ansibgyellow { background-color: yellow; }
.ansibgblue { background-color: blue; }
.ansibgpurple { background-color: magenta; }
.ansibgcyan { background-color: cyan; }
.ansibggray { background-color: gray; }

.ansibold { font-weight: bold; }
</style>
<div class="section" id="network-protocols-in-python">
<h1>Network Protocols in Python<a class="headerlink" href="#network-protocols-in-python" title="Permalink to this headline">¶</a></h1>
<span class="admonition-network-protocols-in-python"></span><p>During this walkthrough we&#8217;ll learn the basics of network protocols.</p>
<p>We&#8217;ll take a look at sample interactions in common network protocols and compare and contrast them.
Doing so can often help us to understand in what situations one protocol would be more appropriate than another.</p>
<p>Finally, we&#8217;ll interact with one of these protocols using a Python implementation from the standard library.
These library implementations will help you to use a protocol without needing to remember the exact specifics of each.</p>
<div class="section" id="what-is-a-protocol">
<h2>What is a Protocol?<a class="headerlink" href="#what-is-a-protocol" title="Permalink to this headline">¶</a></h2>
<p>A protocol is, at it&#8217;s heart, a set of rules or conventions governing communications.
There are a lot of rules in real life that govern how we do things.
For example, what do you say when you get on an elevator?
How should you behave when you are on a first date?
What do you wear when you go on a job interview?
What sorts of topics are okay to discuss at a dinner party?
All of these questions are answered by sets of rules, spoken or unspoken.
These rules form <em>protocols</em>.</p>
<span class="admonition-what-is-a-protocol"></span><div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../_images/icup.png"><img alt="../_images/icup.png" src="../_images/icup.png" style="width: 58%;" /></a>
<p class="caption"><span class="caption-text"><a class="reference external" href="http://blog.xkcd.com/2009/09/02/urinal-protocol-vulnerability/">http://blog.xkcd.com/2009/09/02/urinal-protocol-vulnerability/</a></span></p>
</div>
<span class="admonition-icup"></span><p>Digital life has lots of rules too.
When two computers make contact they have to greet each-other.
They need to identify themselves to each-other.
There are rules about how to ask for information and how answers will be provided.
There are even rules about how to say goodbye when they are finished.</p>
<span class="admonition-digital-rules"></span></div>
<div class="section" id="protocol-examples">
<h2>Protocol Examples<a class="headerlink" href="#protocol-examples" title="Permalink to this headline">¶</a></h2>
<p>To get an idea of what network protocols look like, we&#8217;ll investigate a few of them here.
We&#8217;ll look at three common protocols leading up to our discussion of <a class="reference external" href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a> (the Hypertext Trasfer Protocol).
Our examples will be <a class="reference external" href="http://tools.ietf.org/html/rfc5321#appendix-D">SMTP</a> (Simple Message Transfer Protocol),
<a class="reference external" href="http://www.faqs.org/docs/artu/ch05s03.html">POP3</a> (Post Office Protocol, version 3),
and <a class="reference external" href="http://www.faqs.org/docs/artu/ch05s03.html">IMAP</a> (Internet Message Access Protocol).</p>
<span class="admonition-protocol-examples"></span><div class="section" id="the-smtp-protocol">
<h3>The SMTP Protocol<a class="headerlink" href="#the-smtp-protocol" title="Permalink to this headline">¶</a></h3>
<p>The SMTP Protocol governs the sending of email messages.
Let&#8217;s first look at a few interactions in this protocol.</p>
<p>A few words first about what you are looking at.
Each interaction is line-based, each line represents one message.
Messages from the Server to the Client are prefaced with <code class="docutils literal"><span class="pre">S</span> <span class="pre">(&lt;--)</span></code>.
Messages from the Client to the Server are prefaced with <code class="docutils literal"><span class="pre">C</span> <span class="pre">(--&gt;)</span></code>.
<strong>All</strong> lines end with the character sequence <code class="docutils literal"><span class="pre">&lt;CRLF&gt;</span></code> (<code class="docutils literal"><span class="pre">\r\n</span></code>).</p>
<p>Throughout this document and others, I will be using &lt;CRLF&gt; to represent the combination of two ASCII <em>escape sequences</em>: <code class="docutils literal"><span class="pre">&quot;\r\n&quot;</span></code>
Although you will see this in <strong>all</strong> of the examples you read in this documentation, you should <strong>never</strong> type it.
It should always be replaced with &#8220;rn&#8221;.</p>
<span class="admonition-a-word-on-typography"></span><p>In this first frame, we see a server identifying itself to a client.
The client asks for information from the server about the extensions it supports.
The server responds with a list.</p>
<div class="highlight-python"><div class="highlight"><pre>S (&lt;--): 220 foo.com Simple Mail Transfer Service Ready
C (--&gt;): EHLO bar.com
S (&lt;--): 250-foo.com greets bar.com
S (&lt;--): 250-8BITMIME
S (&lt;--): 250-SIZE
S (&lt;--): 250-DSN
S (&lt;--): 250 HELP
</pre></div>
</div>
<span class="admonition-smtp-greetings"></span><p>In this next frame, the client informs the server that it has mail to deliver.
The server acknowledges this.
The client checks the addressees of the outgoing mail.
One of them is known to the server, the other is not.
The client indicates that it will transmit the message, and the server acknowledges this.
The client delivers the message, terminating it with a single dot on aline by itself.
The server acknowledges that it has received the message.</p>
<div class="highlight-python"><div class="highlight"><pre>C (--&gt;): MAIL FROM:&lt;Smith@bar.com&gt;
S (&lt;--): 250 OK
C (--&gt;): RCPT TO:&lt;Jones@foo.com&gt;
S (&lt;--): 250 OK
C (--&gt;): RCPT TO:&lt;Green@foo.com&gt;
S (&lt;--): 550 No such user here
C (--&gt;): DATA
S (&lt;--): 354 Start mail input; end with &lt;CRLF&gt;.&lt;CRLF&gt;
C (--&gt;): Blah blah blah...
C (--&gt;): ...etc. etc. etc.
C (--&gt;): .
S (&lt;--): 250 OK
</pre></div>
</div>
<span class="admonition-smtp-questions-and-answers"></span><p>In the final frame, the client indicates that it is done.
The server acknowledges this, and closes the socket.</p>
<div class="highlight-python"><div class="highlight"><pre>C (--&gt;): QUIT
S (&lt;--): 221 foo.com Service closing transmission channel
</pre></div>
</div>
<span class="admonition-smtp-say-goodbye"></span><p>A few characteristics of the SMTP protocol become clear looking at this conversation.
First, the interaction consists of commands and replies.</p>
<p>Each command or reply is <em>one line</em> terminated by <code class="docutils literal"><span class="pre">&lt;CRLF&gt;</span></code>.
The glaring exception to the one-line rule is message payload.
To accomodate this, the protocol specifies that payload should be terminated by <code class="docutils literal"><span class="pre">&lt;CRLF&gt;.&lt;CRLF&gt;</span></code>.</p>
<p>Each command has a <em>verb</em> (<code class="docutils literal"><span class="pre">DATA</span></code>, <code class="docutils literal"><span class="pre">RCPT</span></code>, <code class="docutils literal"><span class="pre">EHLO</span></code>) and zero or more <em>arguments</em> (<code class="docutils literal"><span class="pre">TO:&lt;Green&#64;foo.com&gt;</span></code>, <code class="docutils literal"><span class="pre">FROM:&lt;Smith&#64;bar.com&gt;</span></code>).
Each reply has a formal <em>code</em> (<code class="docutils literal"><span class="pre">250</span></code>, <code class="docutils literal"><span class="pre">550</span></code>) and an informal <em>explanation</em> (<code class="docutils literal"><span class="pre">OK</span></code>, <code class="docutils literal"><span class="pre">No</span> <span class="pre">such</span> <span class="pre">user</span> <span class="pre">here</span></code>).</p>
<span class="admonition-smtp-characteristics"></span></div>
<div class="section" id="the-pop3-protocol">
<h3>The POP3 Protocol<a class="headerlink" href="#the-pop3-protocol" title="Permalink to this headline">¶</a></h3>
<p>POP3 is an older protocol that governs the reception of emails.
It is similar in structure to SMTP, though reversed in role.</p>
<p>In this first frame, a client connects and the server indicates it is ready.
The client provides a username and the server indicates the user is known.
The client provides a password and the server accepts it, returning basic information about the user&#8217;s mailbox.</p>
<div class="highlight-python"><div class="highlight"><pre>C (--&gt;): &lt;client connects to service port 110&gt;
S (&lt;--): +OK POP3 server ready &lt;1896.6971@mailgate.dobbs.org&gt;
C (--&gt;): USER bob
S (&lt;--): +OK bob
C (--&gt;): PASS redqueen
S (&lt;--): +OK bob&#39;s maildrop has 2 messages (320 octets)
</pre></div>
</div>
<span class="admonition-pop3-greetings-and-identification"></span><p>In the next frame, the client asks for the status of the mailbox.
The server replies that there are two messages with a total of 320 <code class="docutils literal"><span class="pre">octets</span></code> of data.
The client requests a listing, and the server lists the first message and its size.
The client asks the server to send the message, and the server does.
Again, this interaction takes many lines, and is terminated with a <code class="docutils literal"><span class="pre">&lt;CRLF&gt;.&lt;CRLF&gt;</span></code>.
Finally, the client asks the server to delete the message, and the server replies that is has done so.</p>
<div class="highlight-python"><div class="highlight"><pre>C (--&gt;): STAT
S (&lt;--): +OK 2 320
C (--&gt;): LIST
S (&lt;--): +OK 1 messages (120 octets)
S (&lt;--): 1 120
S (&lt;--): .
C (--&gt;): RETR 1
S (&lt;--): +OK 120 octets
S (&lt;--): &lt;server sends the text of message 1&gt;
S (&lt;--): .
C (--&gt;): DELE 1
S (&lt;--): +OK message 1 deleted
</pre></div>
</div>
<span class="admonition-pop3-questions-and-answers"></span><p>In the final frame, the client indicates it is ready to quit.
The server signs off and the client terminates the connection.</p>
<div class="highlight-python"><div class="highlight"><pre>C (--&gt;): QUIT
S (&lt;--): +OK dewey POP3 server signing off (maildrop empty)
C (--&gt;): &lt;client hangs up&gt;
</pre></div>
</div>
<span class="admonition-pop3-say-goodbye"></span><p>Again, a set of characteristics emerges from this interaction.</p>
<p>Everything is a series of commands and replies.
Each command or reply is <em>one line</em> terminated by <code class="docutils literal"><span class="pre">&lt;CRLF&gt;</span></code>.
Again, the exception to this rule is message payload, which is terminated by <code class="docutils literal"><span class="pre">&lt;CRLF&gt;.&lt;CRLF&gt;</span></code>.</p>
<p>Each command has a <em>verb</em> (<code class="docutils literal"><span class="pre">STAT</span></code>, <code class="docutils literal"><span class="pre">LIST</span></code>, <code class="docutils literal"><span class="pre">RETR</span></code>) and zero or more <em>arguments</em> (<code class="docutils literal"><span class="pre">1</span></code>).
Each reply has a formal <em>code</em> (<code class="docutils literal"><span class="pre">+OK</span></code>) and an informal <em>explanation</em> (<code class="docutils literal"><span class="pre">message</span> <span class="pre">1</span> <span class="pre">deleted</span></code>).
The codes don&#8217;t really look the same, though, do they?</p>
<span class="admonition-pop3-characteristics"></span><p>There&#8217;s one other important difference between SMTP and POP3.
In both protocols an exception to the one-line-per-message rule exists for the payload of an email.
In both protocols, the delineation of this message (the sequence used to indicate it is over) is <code class="docutils literal"><span class="pre">&lt;CRLF&gt;.&lt;CRLF&gt;</span></code>.
But in SMTP, it is the <em>client</em> that has this ability, whereas in POP3 it is the <em>server</em>.</p>
<p>What does that tell you about the <em>purpose</em> of the protocol.
Could you tell what these protocols were for, even if you didn&#8217;t know the names of them?</p>
<span class="admonition-one-other-difference"></span></div>
<div class="section" id="the-imap-protocol">
<h3>The IMAP Protocol<a class="headerlink" href="#the-imap-protocol" title="Permalink to this headline">¶</a></h3>
<p>The IMAP protocol is a more modern protocol for receiving email messages.
It has largely supplanted POP3.
Looking at the protocol can help us to understand why.</p>
<p>In this first frame, the client and the server exchange greetings.
The client provides authentication information and the server accepts it.
Then the client selects a folder to work in and the server provides information about that folder.</p>
<div class="highlight-python"><div class="highlight"><pre>C (--&gt;): &lt;client connects to service port 143&gt;
S (&lt;--): * OK example.com IMAP4rev1 v12.264 server ready
C (--&gt;): A0001 USER &quot;frobozz&quot; &quot;xyzzy&quot;
S (&lt;--): * OK User frobozz authenticated
C (--&gt;): A0002 SELECT INBOX
S (&lt;--): * 1 EXISTS
S (&lt;--): * 1 RECENT
S (&lt;--): * FLAGS (\Answered \Flagged \Deleted \Draft \Seen)
S (&lt;--): * OK [UNSEEN 1] first unseen message in /var/spool/mail/esr
S (&lt;--): A0002 OK [READ-WRITE] SELECT completed
</pre></div>
</div>
<span class="admonition-imap-greetings-information"></span><p>Next, the client asks the server for the size of the first email listed.
The server replies with the data.
The client then asks the server to download the headers from the email.
The server indicates how much data will be sent and then sends it.</p>
<div class="highlight-python"><div class="highlight"><pre>C (--&gt;): A0003 FETCH 1 RFC822.SIZE
S (&lt;--): * 1 FETCH (RFC822.SIZE 2545)
S (&lt;--): A0003 OK FETCH completed
C (--&gt;): A0004 FETCH 1 BODY[HEADER]
S (&lt;--): * 1 FETCH (RFC822.HEADER {1425}
&lt;server sends 1425 octets of message payload&gt;
S (&lt;--): )
S (&lt;--): A0004 OK FETCH completed
</pre></div>
</div>
<span class="admonition-imap-questions-and-answers"></span><p>Finally, the client asks for the body of the first email.
The server tells the client how much data to expect and then sends it.
The client logs out, indicating that it is done.
The server acknowledges this and the client disconnects.</p>
<div class="highlight-python"><div class="highlight"><pre>C (--&gt;): A0005 FETCH 1 BODY[TEXT]
S (&lt;--): * 1 FETCH (BODY[TEXT] {1120}
&lt;server sends 1120 octets of message payload&gt;
S (&lt;--): )
S (&lt;--): * 1 FETCH (FLAGS (\Recent \Seen))
S (&lt;--): A0005 OK FETCH completed
C (--&gt;): A0006 LOGOUT
S (&lt;--): * BYE example.com IMAP4rev1 server terminating connection
S (&lt;--): A0006 OK LOGOUT completed
C (--&gt;): &lt;client hangs up&gt;
</pre></div>
</div>
<span class="admonition-imap-questions-and-goodbye"></span><p>What characteristics emerge from this conversation?</p>
<p>Like with our other protocol examples, interactions consists of commands and replies.
Again, each command or reply is <em>one line</em> terminated by <code class="docutils literal"><span class="pre">&lt;CRLF&gt;</span></code>.
Again, each command has a <em>verb</em> (<code class="docutils literal"><span class="pre">FETCH</span></code>, <code class="docutils literal"><span class="pre">LOGOUT</span></code>) and zero or more <em>arguments</em> (`` 1 BODY[TEXT]``, <code class="docutils literal"><span class="pre">1</span> <span class="pre">RFC822.SIZE</span></code>).
And again, each reply has a formal <em>code</em> (<code class="docutils literal"><span class="pre">OK</span></code>) and an informal <em>explanation</em> (<code class="docutils literal"><span class="pre">[READ-WRITE]</span> <span class="pre">SELECT</span> <span class="pre">completed</span></code>, <code class="docutils literal"><span class="pre">FETCH</span> <span class="pre">completed</span></code>).</p>
<p>But there are important differences too.
For example, in IMAP each command or reply is prefixed by a <em>sequence identifier</em> (<code class="docutils literal"><span class="pre">A0006</span></code>).
And multi-line replies such as fetching message headers or bodies are prefixed with the expected size of the data to be transmitted.
There is no special delineating character that marks the end of the data.</p>
<p>Compared with POP3, what do these differences suggest?
What can you do when you know which replies go with which requests?
What can you do if you know ahead of time how much data will be downloaded?</p>
<span class="admonition-imap-characteristics"></span></div>
</div>
<div class="section" id="using-protocols-in-python">
<h2>Using Protocols in Python<a class="headerlink" href="#using-protocols-in-python" title="Permalink to this headline">¶</a></h2>
<p>To help make these protocols a bit more clear, let&#8217;s play with one ourselves.
Go ahead and start up an iPython interpreter.</p>
<p>Begin by importing the <a class="reference external" href="http://docs.python.org/2/library/imaplib.html#module-imaplib" title="(in Python v2.7)"><code class="xref py py-mod docutils literal"><span class="pre">imaplib</span></code></a> module (<a class="reference external" href="http://docs.python.org/3/library/imaplib.html#module-imaplib" title="(in Python v3.6)"><code class="xref py py-mod docutils literal"><span class="pre">py3</span></code></a>) from the Python standard library.
Then, set the <code class="docutils literal"><span class="pre">Debug</span></code> attribute of the module to <code class="docutils literal"><span class="pre">4</span></code> so that we can see the messages sent back and forth between the server and ourselves.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [1]: </span><span class="kn">import</span> <span class="nn">imaplib</span>
<span class="gp">In [2]: </span><span class="nb">dir</span><span class="p">(</span><span class="n">imaplib</span><span class="p">)</span>
<span class="gh">Out[2]:</span>
<span class="go">[&#39;AllowedVersions&#39;,</span>
<span class="go"> &#39;CRLF&#39;,</span>
<span class="go"> &#39;Commands&#39;,</span>
<span class="go">...</span>
<span class="go"> &#39;timedelta&#39;,</span>
<span class="go"> &#39;timezone&#39;]</span>
<span class="gp">In [3]: </span><span class="n">imaplib</span><span class="o">.</span><span class="n">Debug</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>
</div>
<span class="admonition-playing-with-imap"></span><p>I&#8217;ve prepared a server for us to use, but we&#8217;ll need to set up a client to speak to it.
Our server requires SSL (Secure Socket Layer) for connecting to IMAP servers, so let&#8217;s initialize an IMAP4_SSL client.
Then we will authenticate by providing a username and password.
The correct values to use here will be passed out via the class slack channel.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [4]: </span><span class="n">conn</span> <span class="o">=</span> <span class="n">imaplib</span><span class="o">.</span><span class="n">IMAP4_SSL</span><span class="p">(</span><span class="s1">&#39;mail.webfaction.com&#39;</span><span class="p">)</span>
<span class="go">  22:40.32 imaplib version 2.58</span>
<span class="go">  22:40.32 new IMAP4 connection, tag=b&#39;IMKC&#39;</span>
<span class="go">  22:40.38 &lt; b&#39;* OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE AUTH=PLAIN] Dovecot ready.&#39;</span>
<span class="go">  22:40.38 &gt; b&#39;IMKC0 CAPABILITY&#39;</span>
<span class="go">  22:40.45 &lt; b&#39;* CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE AUTH=PLAIN&#39;</span>
<span class="go">  22:40.45 &lt; b&#39;IMKC0 OK Capability completed.&#39;</span>
<span class="go">  22:40.45 CAPABILITIES: (&#39;IMAP4REV1&#39;, &#39;LITERAL+&#39;, &#39;SASL-IR&#39;, &#39;LOGIN-REFERRALS&#39;, &#39;ID&#39;, &#39;ENABLE&#39;, &#39;IDLE&#39;, &#39;AUTH=PLAIN&#39;)</span>
<span class="gp">In [5]: </span><span class="n">conn</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>
<span class="go">  22:59.92 &gt; b&#39;IMKC1 LOGIN username &quot;password&quot;&#39;</span>
<span class="go">  23:01.79 &lt; b&#39;* CAPABILITY IMAP4rev1 SASL-IR SORT THREAD=REFERENCES MULTIAPPEND UNSELECT LITERAL+ IDLE CHILDREN NAMESPACE LOGIN-REFERRALS STARTTLS AUTH=PLAIN&#39;</span>
<span class="go">  23:01.79 &lt; b&#39;IMKC1 OK Logged in.&#39;</span>
<span class="gh">Out[5]: </span><span class="go">(&#39;OK&#39;, [b&#39;Logged in.&#39;])</span>
</pre></div>
</div>
<span class="admonition-connecting-and-authenticating"></span><p>Once we have logged in, we can start by <a class="reference external" href="http://docs.python.org/2/library/imaplib.html#imaplib.IMAP4.list" title="(in Python v2.7)"><code class="xref py py-meth docutils literal"><span class="pre">listing</span></code></a> (<a class="reference external" href="http://docs.python.org/3/library/imaplib.html#imaplib.IMAP4.list" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">py3</span></code></a>) the mailboxes we have on the server.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [6]: </span><span class="n">conn</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
<span class="go">  26:30.64 &gt; b&#39;IMKC2 LIST &quot;&quot; *&#39;</span>
<span class="go">  26:30.72 &lt; b&#39;* LIST (\\HasNoChildren) &quot;.&quot; &quot;Trash&quot;&#39;</span>
<span class="go">  26:30.72 &lt; b&#39;* LIST (\\HasNoChildren) &quot;.&quot; &quot;Drafts&quot;&#39;</span>
<span class="go">  26:30.72 &lt; b&#39;* LIST (\\HasNoChildren) &quot;.&quot; &quot;Sent&quot;&#39;</span>
<span class="go">  26:30.72 &lt; b&#39;* LIST (\\HasNoChildren) &quot;.&quot; &quot;Junk&quot;&#39;</span>
<span class="go">  26:30.72 &lt; b&#39;* LIST (\\HasNoChildren) &quot;.&quot; &quot;INBOX&quot;&#39;</span>
<span class="go">  26:30.72 &lt; b&#39;IMKC2 OK List completed.&#39;</span>
<span class="gh">Out[6]:</span>
<span class="go">(&#39;OK&#39;,</span>
<span class="go"> [b&#39;(\\HasNoChildren) &quot;.&quot; &quot;Trash&quot;&#39;,</span>
<span class="go">  b&#39;(\\HasNoChildren) &quot;.&quot; &quot;Drafts&quot;&#39;,</span>
<span class="go">  b&#39;(\\HasNoChildren) &quot;.&quot; &quot;Sent&quot;&#39;,</span>
<span class="go">  b&#39;(\\HasNoChildren) &quot;.&quot; &quot;Junk&quot;&#39;,</span>
<span class="go">  b&#39;(\\HasNoChildren) &quot;.&quot; &quot;INBOX&quot;&#39;])</span>
</pre></div>
</div>
<span class="admonition-listing-mailboxes"></span><p>To interact with our email, we must <a class="reference external" href="http://docs.python.org/2/library/imaplib.html#imaplib.IMAP4.select" title="(in Python v2.7)"><code class="xref py py-meth docutils literal"><span class="pre">select</span></code></a> (<a class="reference external" href="http://docs.python.org/3/library/imaplib.html#imaplib.IMAP4.select" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">py3</span></code></a>) a mailbox from the list we received earlier.
We use the name of the mailbox as the argument to the method.
Then the commands we give will be taken on messages held in that mailbox only.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [7]: </span><span class="n">conn</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;INBOX&#39;</span><span class="p">)</span>
<span class="go">  27:20.96 &gt; b&#39;IMKC3 SELECT INBOX&#39;</span>
<span class="go">  27:21.04 &lt; b&#39;* FLAGS (\\Answered \\Flagged \\Deleted \\Seen \\Draft)&#39;</span>
<span class="go">  27:21.04 &lt; b&#39;* OK [PERMANENTFLAGS (\\Answered \\Flagged \\Deleted \\Seen \\Draft \\*)] Flags permitted.&#39;</span>
<span class="go">  27:21.04 &lt; b&#39;* 1 EXISTS&#39;</span>
<span class="go">  27:21.04 &lt; b&#39;* 0 RECENT&#39;</span>
<span class="go">  27:21.04 &lt; b&#39;* OK [UNSEEN 1] First unseen.&#39;</span>
<span class="go">  27:21.04 &lt; b&#39;* OK [UIDVALIDITY 1357449499] UIDs valid&#39;</span>
<span class="go">  27:21.04 &lt; b&#39;* OK [UIDNEXT 24] Predicted next UID&#39;</span>
<span class="go">  27:21.04 &lt; b&#39;IMKC3 OK [READ-WRITE] Select completed.&#39;</span>
<span class="gh">Out[7]: </span><span class="go">(&#39;OK&#39;, [b&#39;1&#39;])</span>
</pre></div>
</div>
<span class="admonition-selecting-an-inbox"></span><p>We can <a class="reference external" href="http://docs.python.org/2/library/imaplib.html#imaplib.IMAP4.search" title="(in Python v2.7)"><code class="xref py py-meth docutils literal"><span class="pre">search</span></code></a> (<a class="reference external" href="http://docs.python.org/3/library/imaplib.html#imaplib.IMAP4.search" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">py3</span></code></a>) our selected mailbox for messages matching one or more criteria.
The syntax for searching asks for an encoding (if you are using special unicode characters) and then a special statement indicating what you are searching for and in what part of messages to look.</p>
<div class="build container">
<p>The return value is a list of bytestrings containing the UIDs of messages
that match our search:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [8]: </span><span class="n">conn</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;(FROM &quot;cris&quot;)&#39;</span><span class="p">)</span>
<span class="go">  28:43.02 &gt; b&#39;IMKC4 SEARCH (FROM &quot;cris&quot;)&#39;</span>
<span class="go">  28:43.09 &lt; b&#39;* SEARCH 1&#39;</span>
<span class="go">  28:43.09 &lt; b&#39;IMKC4 OK Search completed.&#39;</span>
<span class="gh">Out[8]: </span><span class="go">(&#39;OK&#39;, [b&#39;1&#39;])</span>
</pre></div>
</div>
</div>
<span class="admonition-searching"></span><p>Once we&#8217;ve found a message we want to look at, we can use the <a class="reference external" href="http://docs.python.org/3/library/imaplib.html#imaplib.IMAP4.fetch" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">fetch</span></code></a> (<a class="reference external" href="http://docs.python.org/3/library/imaplib.html#imaplib.IMAP4.fetch" title="(in Python v3.6)"><code class="xref py py-meth docutils literal"><span class="pre">py3</span></code></a>) command to read it from the server.
The command requires two arguments, the ID of the message we want, and then a designator of the message part we want to fetch.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [9]: </span><span class="n">conn</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;BODY[HEADER]&#39;</span><span class="p">)</span>
<span class="go">  ...</span>
<span class="gh">Out[9]: </span><span class="go">(&#39;OK&#39;, ...)</span>

<span class="gp">In [10]: </span><span class="n">conn</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAGS&#39;</span><span class="p">)</span>
<span class="go">  ...</span>
<span class="gh">Out[10]: </span><span class="go">(&#39;OK&#39;, [b&#39;1 (FLAGS (\\Seen))&#39;])</span>

<span class="gp">In [11]: </span><span class="n">conn</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;BODY[TEXT]&#39;</span><span class="p">)</span>
<span class="go">  ...</span>
<span class="gh">Out[11]: </span><span class="go">(&#39;OK&#39;, ...)</span>
</pre></div>
</div>
<span class="admonition-fetching"></span><div class="section" id="python-means-batteries-included">
<h3>Python Means Batteries Included<a class="headerlink" href="#python-means-batteries-included" title="Permalink to this headline">¶</a></h3>
<p>It&#8217;s a bit hard to decipher the message from the body text we downloaded directly via IMAP.
We can use the <a class="reference external" href="http://docs.python.org/2/library/email.html#module-email" title="(in Python v2.7)"><code class="xref py py-mod docutils literal"><span class="pre">email</span></code></a> module (<a class="reference external" href="http://docs.python.org/3/library/email.html#module-email" title="(in Python v3.6)"><code class="xref py py-mod docutils literal"><span class="pre">py3</span></code></a>) to construct an email object from the RFC822 format message.
Begin by fetching the message from the IMAP server in the appropriate format:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [12]: </span><span class="kn">import</span> <span class="nn">email</span>
<span class="gp">In [13]: </span><span class="n">code</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;(RFC822)&#39;</span><span class="p">)</span>
<span class="go">  13:14.75 &gt; b&#39;BLBK5 FETCH 1 (RFC822)&#39;</span>
<span class="go">  13:14.91 &lt; b&#39;* 1 FETCH (RFC822 {5310}&#39;</span>
<span class="go">  13:14.91 read literal size 5310</span>
<span class="go">  13:15.01 &lt; b&#39;)&#39;</span>
<span class="go">  13:15.01 &lt; b&#39;BLBK5 OK Fetch completed.&#39;</span>

<span class="gp">In [14]: </span><span class="n">code</span>
<span class="gh">Out[14]: </span><span class="go">&#39;OK&#39;</span>

<span class="gp">In [15]: </span><span class="n">data</span>
<span class="gh">Out[15]:</span>
<span class="go">[(b&#39;1 (RFC822 {5310}&#39;,</span>
<span class="go">  b&#39;Return-Path: &lt;cris@crisewing.com&gt;\r\n</span>
<span class="go">  ...</span>
</pre></div>
</div>
<span class="admonition-batteries-included"></span><p>The return value is a code and the data we requested.
The data is in the format of a tuple, which we can use to build an email message using the <a class="reference external" href="http://docs.python.org/2/library/email.parser.html#email.message_from_string" title="(in Python v2.7)"><code class="docutils literal"><span class="pre">email.message_from_string()</span></code></a> function (in Python 3 this is renamed to <a class="reference external" href="http://docs.python.org/3/library/email.parser.html#email.message_from_bytes" title="(in Python v3.6)"><code class="xref py py-func docutils literal"><span class="pre">email.message_from_bytes()</span></code></a>).
The resulting <code class="xref py py-class docutils literal"><span class="pre">message</span> <span class="pre">object</span></code> (<code class="xref py py-class docutils literal"><span class="pre">py3</span></code>) holds headers from the original email in key-value pairs (like a <code class="docutils literal"><span class="pre">dict</span></code>):</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [16]: </span><span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<span class="gp">   ....: </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="gp">   ....: </span>        <span class="n">msg</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message_from_bytes</span><span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="gp">   ....:</span>
<span class="gp">In [17]:</span>
</pre></div>
</div>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [18]: </span><span class="n">msg</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="gh">Out[18]:</span>
<span class="go">[&#39;Return-Path&#39;,</span>
<span class="go"> &#39;X-Original-To&#39;,</span>
<span class="go"> &#39;Delivered-To&#39;,</span>
<span class="go"> ...</span>

<span class="gp">In [19]: </span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span>
<span class="gh">Out[19]: </span><span class="go">&#39;demo@crisewing.com&#39;</span>
</pre></div>
</div>
<span class="admonition-build-an-email-object"></span><p>And we can get the payload of the message, and print the non-html portion of it:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [29]: </span><span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
<span class="go">Content-Transfer-Encoding: quoted-printable</span>
<span class="go">Content-Type: text/plain;</span>
<span class="go">    charset=us-ascii</span>

<span class="go">If you are reading this email, you&#39;ve managed to download it from the =</span>
<span class="go">mailbox using IMAP.</span>

<span class="go">Don&#39;t you feel accomplished?</span>

<span class="go">Now, on to bigger and better tasks!</span>


<span class="go">Cris Ewing</span>
<span class="gt">--------------------------------------------------</span>
<span class="n">Principal</span><span class="p">,</span> <span class="n">Cris</span> <span class="n">Ewing</span><span class="p">,</span> <span class="n">Developer</span> <span class="n">LLC</span>
<span class="ne">http</span>://www.crisewing.com
<span class="n">cris</span><span class="nd">@crisewing.com</span>
<span class="mi">1</span><span class="o">.</span><span class="mf">206.724</span><span class="o">.</span><span class="mi">2112</span>
</pre></div>
</div>
<span class="admonition-read-the-email"></span></div>
</div>
<div class="section" id="wrap-up">
<h2>Wrap Up<a class="headerlink" href="#wrap-up" title="Permalink to this headline">¶</a></h2>
<p>In this lesson we have learned that protocols are just a set of rules for how to communicate.
We&#8217;ve learned that among these rules are ones to tell us how we can parse messages sent using a protocol.
We can also tell which messages are valid according to a protocol.</p>
<p>If we properly format messages we send <em>to</em> a server, we can get messages in response <em>from</em> the server.
Python has built-in modules to support a number of these protocols.
The modules allow you to use a Python API to interact with the protocol, so you don&#8217;t have to remember exactly how to format the messages you send.</p>
<p>But in every case we&#8217;ve seen today, you could accomplish the same things by properly formatting a byte string and sending it through a socket to a server.</p>
<p>Armed with this knowledge, we&#8217;ll next look at a particular protocol.
One we will be using for the rest of our class.
This protocol is HTTP.</p>
<span class="admonition-summary"></span></div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Network Protocols in Python</a><ul>
<li><a class="reference internal" href="#what-is-a-protocol">What is a Protocol?</a></li>
<li><a class="reference internal" href="#protocol-examples">Protocol Examples</a><ul>
<li><a class="reference internal" href="#the-smtp-protocol">The SMTP Protocol</a></li>
<li><a class="reference internal" href="#the-pop3-protocol">The POP3 Protocol</a></li>
<li><a class="reference internal" href="#the-imap-protocol">The IMAP Protocol</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-protocols-in-python">Using Protocols in Python</a><ul>
<li><a class="reference internal" href="#python-means-batteries-included">Python Means Batteries Included</a></li>
</ul>
</li>
<li><a class="reference internal" href="#wrap-up">Wrap Up</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">Python 401 2.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014-2016, Cris Ewing, Nicholas Hunt-Walker.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
  </body>
</html>