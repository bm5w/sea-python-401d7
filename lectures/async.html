<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Concurrency &mdash; Python 401 2.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Python 401 2.1 documentation" href="../index.html" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />

<link rel="stylesheet" href="../_static/custom.css" type="text/css" media="screen" charset="utf-8" />

<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head>
  <body role="document">
<div class="header">
  <div class="logo">
    <a href="../index.html">
      <img class="logo" src="../_static/cf_logo.png" alt="Logo"/>
      <p>Code Fellows</p>
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">Python 401 2.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput > div,
div.nbinput div[class^=highlight],
div.nbinput div[class^=highlight] pre,
div.nboutput,
div.nboutput > div,
div.nboutput div[class^=highlight],
div.nboutput div[class^=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput > :first-child pre {
    color: navy;
}

/* output prompt */
div.nboutput > :first-child pre {
    color: darkred;
}

/* all prompts */
div.nbinput > :first-child[class^=highlight],
div.nboutput > :first-child[class^=highlight],
div.nboutput > :first-child {
    min-width: 11ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}

/* input/output area */
div.nbinput > :nth-child(2)[class^=highlight],
div.nboutput > :nth-child(2),
div.nboutput > :nth-child(2)[class^=highlight] {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
}

/* input area */
div.nbinput > :nth-child(2)[class^=highlight] {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput  > :nth-child(2).stderr {
    background: #fdd;
}

/* ANSI colors */
.ansiblack { color: black; }
.ansired { color: darkred; }
.ansigreen { color: darkgreen; }
.ansiyellow { color: #c4a000; }
.ansiblue { color: darkblue; }
.ansipurple { color: darkviolet; }
.ansicyan { color: steelblue; }
/* See https://github.com/jupyter/nbconvert/issues/174 */
.ansigray { color: gray; }  /* nbconvert CSS */
.ansigrey { color: gray; }  /* nbconvert HTML output */

.ansibgblack { background-color: black; }
.ansibgred { background-color: red; }
.ansibggreen { background-color: green; }
.ansibgyellow { background-color: yellow; }
.ansibgblue { background-color: blue; }
.ansibgpurple { background-color: magenta; }
.ansibgcyan { background-color: cyan; }
.ansibggray { background-color: gray; }

.ansibold { font-weight: bold; }
</style>
<div class="section" id="concurrency">
<h1>Concurrency<a class="headerlink" href="#concurrency" title="Permalink to this headline">¶</a></h1>
<p><strong>Concurrency</strong>: Doing more than one thing at a time</p>
<div class="section" id="concurrency-in-python">
<h2>Concurrency In Python<a class="headerlink" href="#concurrency-in-python" title="Permalink to this headline">¶</a></h2>
<div class="left container">
<p>We&#8217;ve been working for a few days now on writing servers and clients in Python.</p>
<p>To do so, we&#8217;ve made extensive use of the <a class="reference external" href="http://docs.python.org/2/library/socket.html#module-socket" title="(in Python v2.7)"><code class="xref py py-mod docutils literal"><span class="pre">socket</span></code></a> (<a class="reference external" href="http://docs.python.org/3/library/socket.html#module-socket" title="(in Python v3.6)"><code class="xref py py-mod docutils literal"><span class="pre">py3</span></code></a>) library
and the interface it provides to low-level network I/O primitives.</p>
<p>There&#8217;s a problem with the code we&#8217;ve been writing, however. It is <strong>blocking</strong>.</p>
</div>
<div class="section" id="blocking-calls">
<h3>Blocking Calls<a class="headerlink" href="#blocking-calls" title="Permalink to this headline">¶</a></h3>
<p>Consider the following code, our basic echo server:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">server</span><span class="p">():</span>
    <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">buffsize</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="hll">            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span> <span class="c1"># blocking</span>
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">buffsize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                        <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">conn</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>The call to <code class="docutils literal"><span class="pre">socket.accept</span></code> on line 11 is <em>blocking</em>.
It will not return until a new connection is made by a client.</p>
<p>This means that although in principle our server can handle more than one connection (it has a backlog of 5, right?),
in fact it is only able to process one request at a time.</p>
<p>Even for a trivial program like this, this is a problem.
What if the message the client is sending us to be echoed back is the collected works of Shakespeare?
Any other clients looking to have their simple messages echoed would be forced to wait while we process Shakespeare 16 bytes at a time.</p>
<p>Operations that <code class="docutils literal"><span class="pre">block</span></code> like this are called <em>synchronous</em>.
Getting around them is one of the tasks that comes with scaling a program.</p>
</div>
</div>
<div class="section" id="simple-concurrency-w-select">
<h2>Simple Concurrency w/ <code class="docutils literal"><span class="pre">select</span></code><a class="headerlink" href="#simple-concurrency-w-select" title="Permalink to this headline">¶</a></h2>
<div class="left container">
<p>The Python standard library provides the <code class="docutils literal"><span class="pre">select</span></code> module to help us alleviate some of the issues with blocking I/O operations.</p>
<p>The module provides <code class="docutils literal"><span class="pre">select</span></code>, an interface to the underlying Unix <code class="docutils literal"><span class="pre">select</span></code> system call.
The purpose of select is to take a list of possible I/O channels (file handles, Unix sockets, network sockets)
and return lists of those that are ready to be read, written or in an error state.</p>
</div>
<div class="section" id="using-select">
<h3>Using <code class="docutils literal"><span class="pre">select</span></code><a class="headerlink" href="#using-select" title="Permalink to this headline">¶</a></h3>
<p>Consider the following update to our echo server code:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">server</span><span class="p">(</span><span class="n">log_buffer</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">):</span>
    <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">server_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">server_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="n">server_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">buffsize</span> <span class="o">=</span> <span class="mi">16</span>

<span class="hll">    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">server_socket</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">]</span>
</span><span class="hll">    <span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
</span>
    <span class="k">while</span> <span class="n">running</span><span class="p">:</span>

<span class="hll">        <span class="n">read_ready</span><span class="p">,</span> <span class="n">write_ready</span><span class="p">,</span> <span class="n">except_ready</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)</span>
</span>
        <span class="k">for</span> <span class="n">readable</span> <span class="ow">in</span> <span class="n">read_ready</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">readable</span> <span class="ow">is</span> <span class="n">server_socket</span><span class="p">:</span>
                <span class="c1"># spin up new handler sockets as clients connect</span>
                <span class="n">handler_socket</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">readable</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span> <span class="c1"># won&#39;t block now</span>
                <span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler_socket</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">readable</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
                <span class="c1"># handle any stdin by terminating the server</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># handle each client connection 1 buffer at a time</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">readable</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">buffsize</span><span class="p">)</span> <span class="c1"># also won&#39;t block</span>
<span class="hll">                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
</span>                    <span class="c1"># return one buffer&#39;s worth of message to the client</span>
                    <span class="n">readable</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">readable</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">channels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">readable</span><span class="p">)</span>

    <span class="n">server_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="what-s-changed">
<h3>What&#8217;s Changed<a class="headerlink" href="#what-s-changed" title="Permalink to this headline">¶</a></h3>
<p>This code has incorporated <code class="docutils literal"><span class="pre">select.select</span></code> in order to allow the outer loop
to continue running regardless of the readiness of any given I/O operation.</p>
<p>On line 9-10, we initialize a list of possible I/O sources by providing the
server socket we&#8217;ve created and <code class="docutils literal"><span class="pre">sys.stdin</span></code>, which we will use to
gracefully terminate the server.</p>
<p>On line 14, we pass this initialized list of I/O sources into a call to
<code class="docutils literal"><span class="pre">select.select</span></code> as the potential readables. The list of potential
writables and potential exceptions can be ignored for this application. By
additionally providing a <code class="docutils literal"><span class="pre">timeout</span></code> value of <code class="docutils literal"><span class="pre">0</span></code>, we ensure that this
call to <code class="docutils literal"><span class="pre">select.select</span></code> will not block the loop. If no sources are ready
for reading when the call is executed, the lists will be returned empty and
we&#8217;ll simply move on to the next iteration.</p>
<p>When the list of I/O sources bound to <code class="docutils literal"><span class="pre">read_ready</span></code> is non-empty, we use a
for loop construct to handle each read_ready source individually.</p>
<p>Now, when we call <code class="docutils literal"><span class="pre">accept</span></code> on the original server socket on line 20, we
can be assured that in fact a client <em>has</em> made a connection and the call
will return immediately. When it does, we add the new socket it has given
us, which represents the connection to the client, to the list of inputs so
that it can be processed by <code class="docutils literal"><span class="pre">select</span></code> along with our server and stdin
sources.</p>
<p>Once a handler for a client has been added to the list of inputs, it might
also be one of the items in the <code class="docutils literal"><span class="pre">read_ready</span></code> list returned by the call to
<code class="docutils literal"><span class="pre">select.</span></code> This brings us to line 31, where a single buffer of data is
received from the client. The data is immediately returned to the client,
if present.</p>
<p>In this way, a series of longer messages from clients may be handled
concurrently, with each being dealt with one buffer at a time. All requests
might take a bit longer than they would have if they came in one at a time,
but the aggregate time spent for a message received when the load is heavy
will be lower. Shakespeare will no longer prevent a smaller message from
being processed in a timely fashion.</p>
</div>
<div class="section" id="what-hasn-t-changed">
<h3>What Hasn&#8217;t Changed<a class="headerlink" href="#what-hasn-t-changed" title="Permalink to this headline">¶</a></h3>
<p>For a simple process like this echo server, an update like this might be enough
to solve the problem. But what if the job the server needs to accomplish for
any given connection is more complex? Even if we are handling jobs &#8220;at the same
time&#8221;, we still need to deal with the length of time it takes each job to run
through a given cycle.</p>
<p>Although we&#8217;ve woven a number of tasks together, completing any one of them can
still have a significant impact on how quickly any others might be completed.</p>
</div>
</div>
<div class="section" id="batteries-included">
<h2>Batteries Included<a class="headerlink" href="#batteries-included" title="Permalink to this headline">¶</a></h2>
<p class="left">Python provides us with a couple of possible solutions within the standard
library: <a class="reference external" href="http://docs.python.org/2/library/threading.html">threading</a> and <a class="reference external" href="http://docs.python.org/2/library/multiprocessing.html">multiprocessing</a>. Each takes a different approach
to solving the problem of sharing resources among concurrent tasks.</p>
<div class="section" id="id1">
<h3>Threading<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">threading</span></code> module extends and provides a more useable API for the
older, more basic <code class="docutils literal"><span class="pre">thread</span></code> module.  You should never need to address the
<code class="docutils literal"><span class="pre">thread</span></code> module directly.</p>
<p>Threads are lightweight, independent processes that share the memory space
used by the process that spawns them. This allows for great convenience in
processing shared data. But that convenience comes at the price of
complexity, as using threads can lead to <a class="reference external" href="https://en.wikipedia.org/wiki/Race_condition">race conditions</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Deadlock">deadlocks</a> and
other hard-to-debug problems unless done with the greatest of care.</p>
<p>To use threading in our echo server, we could spin off a new thread for
every client connection and allow the thread to run itself. A reasonable
example of this approach, implemented as a set of Python classes,
<a class="reference external" href="http://ilab.cs.byu.edu/python/threadingmodule.html">can be seen here</a>.</p>
<p>But threading doesn&#8217;t really solve our problems.  Although it <em>does</em>
ostensibly create a separate process in which to run the handler code for a
client connection, in reality, that process shares the <a class="reference external" href="http://jessenoller.com/blog/2009/02/01/python-threads-and-the-global-interpreter-lock">GIL</a> and so even
though it is running &#8216;separately&#8217;, it&#8217;s bound by the same resource
limitations as simply using <code class="docutils literal"><span class="pre">select</span></code>.</p>
</div>
<div class="section" id="id2">
<h3>Multiprocessing<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">multiprocessing</span></code> module basically offers that same API as the
threading module. So using it would look much like the example linked
above, except that we would create the <code class="docutils literal"><span class="pre">Client</span></code> class as a subclass of
<code class="docutils literal"><span class="pre">multiprocessing.Process</span></code> rather than <code class="docutils literal"><span class="pre">threading.Thread</span></code>.</p>
<p>Multiprocessing differs from threading in that it creates completely
separate processes rather than lightweight threads. The processes created
<strong>do not share</strong> memory space with each-other, and so if you have a need to
mutate some shared state with multiprocessing, you&#8217;ll need to pass messages
or data from one process to another.</p>
<p>On the other hand, because they do not share memory, much of the challenge
of threaded programming is avoided. There is no worry about deadlocks and
race conditions because no two processes are working with the same
resources.</p>
<p>It appears that there is general agreement that the future of concurrent
programming in Python lies more along the path of multiprocessing than
threading. It&#8217;s easier to comprehend, fits better with the mental model
most programmers have of processes running in isolation, and the drawbacks
of isolation can be reduced with not too much effort.</p>
</div>
</div>
<div class="section" id="asynchronous-concurrency">
<h2>Asynchronous Concurrency<a class="headerlink" href="#asynchronous-concurrency" title="Permalink to this headline">¶</a></h2>
<p class="left">Another approach to the issue of concurrency is to treat the problem
asynchronously. This approach uses the idea of <em>events</em> to handle I/O
outside the flow of the main process.</p>
<div class="left container">
If you think of the fact of a client connecting to a server socket as
an event, then when such an event happens, you can hand off the problem
of dealing with that event to a <em>handler</em>. The handler can go on it&#8217;s
merry way, doing what it needs to do, without concern for what happens
back in the server process.</div>
<div class="section" id="asynchronous-models">
<h3>Asynchronous Models<a class="headerlink" href="#asynchronous-models" title="Permalink to this headline">¶</a></h3>
<p>There are two models for this type of <em>event-driven</em> operation: Callbacks
and Coroutines. These two methods are nicely modeled by two well-known
packages in the Python ecosystem: <a class="reference external" href="http://twistedmatrix.com/documents/current/core/howto/index.html">twisted</a> and <a class="reference external" href="http://www.gevent.org/contents.html">gevent</a></p>
<p>With either of these packages, it&#8217;s possible to write our echo server to
handle incoming requests asynchronously. This can enable enourmous
concurrency allowing a server to deal with incoming requests on the order
of tens of thousands at once.</p>
<p>For today, we&#8217;ll be using gevent. The advantage of gevent over twisted is
that it allows you to write code as if it were synchronous, without needing
to worry about when it might be interrupted.</p>
<p>The code for this example is remarkably light, simply because the majority
of the work is done by a <code class="docutils literal"><span class="pre">StreamServer</span></code> class provided by gevent. All we
have to do is write the portion that actually handles a single client
connection.</p>
</div>
<div class="section" id="an-echo-handler">
<h3>An Echo Handler<a class="headerlink" href="#an-echo-handler" title="Permalink to this headline">¶</a></h3>
<p>Consider the following code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a simple echoing handler for incoming client connections</span>

<span class="sd">    It will be used for each incoming connection on a separate greenlet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buffsize</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">buffsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">break</span>
</pre></div>
</div>
<p>This code looks remarkably like the connection-handling code from our
original server, and from the <code class="docutils literal"><span class="pre">select</span></code> version above. In fact, it is
exactly the same, minus the work needed to manage readable sockets for
select.</p>
</div>
<div class="section" id="the-streamserver-in-action">
<h3>The <code class="docutils literal"><span class="pre">StreamServer</span></code> in Action<a class="headerlink" href="#the-streamserver-in-action" title="Permalink to this headline">¶</a></h3>
<p>Here&#8217;s how you run such a server:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">gevent.server</span> <span class="kn">import</span> <span class="n">StreamServer</span>
    <span class="kn">from</span> <span class="nn">gevent.monkey</span> <span class="kn">import</span> <span class="n">patch_all</span>
    <span class="n">patch_all</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">StreamServer</span><span class="p">((</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">),</span> <span class="n">echo</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting echo server on port 10000&#39;</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>Note the call to <code class="docutils literal"><span class="pre">gevent.monkey.patch_all</span></code>. Gevent works by leveraging a
low-level library called <code class="docutils literal"><span class="pre">libevent</span></code>. To accomodate this library, it makes
some changes to how blocking is handled by code in a number of standard
Python libraries such as socket. In order to fully take advantage of these
optimizations, calling one of the patch functions from <code class="docutils literal"><span class="pre">gevent.monkey</span></code>
(or simply calling <code class="docutils literal"><span class="pre">patch_all</span></code>) will apply these changes so that if you
are using a library built on one of these bases (such as <code class="docutils literal"><span class="pre">requests</span></code>) you
can take advantage of the asynchronous I/O provided by gevent.</p>
</div>
</div>
<div class="section" id="use-what-you-ve-learned">
<h2>Use What You&#8217;ve Learned<a class="headerlink" href="#use-what-you-ve-learned" title="Permalink to this headline">¶</a></h2>
<div class="left build container">
<p>In this short lesson, we&#8217;ve explored a number of ways of solving the
problem of <em>blocking code</em> with <em>concurrency</em>.</p>
<p>I&#8217;ve attached samples of a working version of the echo server implemented
in blocking style, using <code class="docutils literal"><span class="pre">select</span></code> and using <code class="docutils literal"><span class="pre">gevent</span></code> to this lecture as
<a class="reference download internal" href="../_downloads/echo_server_sync.tgz"><code class="xref download docutils literal"><span class="pre">echo_server_sync.tgz</span></code></a>.</p>
<p>Your task is to update your HTTP server using one of the techniques
described above: <code class="docutils literal"><span class="pre">select</span></code>, <code class="docutils literal"><span class="pre">threading</span></code>, <code class="docutils literal"><span class="pre">multiprocessing</span></code> or
<code class="docutils literal"><span class="pre">asynchronous</span> <span class="pre">concurrency</span></code>.</p>
<p>If you choose to use <code class="docutils literal"><span class="pre">asynchronous</span> <span class="pre">concurrency</span></code> you may choose either
<code class="docutils literal"><span class="pre">gevent</span></code> (demoed here) or <code class="docutils literal"><span class="pre">twisted</span></code>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Concurrency</a><ul>
<li><a class="reference internal" href="#concurrency-in-python">Concurrency In Python</a><ul>
<li><a class="reference internal" href="#blocking-calls">Blocking Calls</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simple-concurrency-w-select">Simple Concurrency w/ <code class="docutils literal"><span class="pre">select</span></code></a><ul>
<li><a class="reference internal" href="#using-select">Using <code class="docutils literal"><span class="pre">select</span></code></a></li>
<li><a class="reference internal" href="#what-s-changed">What&#8217;s Changed</a></li>
<li><a class="reference internal" href="#what-hasn-t-changed">What Hasn&#8217;t Changed</a></li>
</ul>
</li>
<li><a class="reference internal" href="#batteries-included">Batteries Included</a><ul>
<li><a class="reference internal" href="#id1">Threading</a></li>
<li><a class="reference internal" href="#id2">Multiprocessing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#asynchronous-concurrency">Asynchronous Concurrency</a><ul>
<li><a class="reference internal" href="#asynchronous-models">Asynchronous Models</a></li>
<li><a class="reference internal" href="#an-echo-handler">An Echo Handler</a></li>
<li><a class="reference internal" href="#the-streamserver-in-action">The <code class="docutils literal"><span class="pre">StreamServer</span></code> in Action</a></li>
</ul>
</li>
<li><a class="reference internal" href="#use-what-you-ve-learned">Use What You&#8217;ve Learned</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">Python 401 2.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014-2016, Cris Ewing, Nicholas Hunt-Walker.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
  </body>
</html>