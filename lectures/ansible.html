<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Automated Deployment with Ansible &mdash; Python 401 2.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Python 401 2.1 documentation" href="../index.html" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />

<link rel="stylesheet" href="../_static/custom.css" type="text/css" media="screen" charset="utf-8" />

<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head>
  <body role="document">
<div class="header">
  <div class="logo">
    <a href="../index.html">
      <img class="logo" src="../_static/cf_logo.png" alt="Logo"/>
      <p>Code Fellows</p>
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">Python 401 2.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput > div,
div.nbinput div[class^=highlight],
div.nbinput div[class^=highlight] pre,
div.nboutput,
div.nboutput > div,
div.nboutput div[class^=highlight],
div.nboutput div[class^=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput > :first-child pre {
    color: navy;
}

/* output prompt */
div.nboutput > :first-child pre {
    color: darkred;
}

/* all prompts */
div.nbinput > :first-child[class^=highlight],
div.nboutput > :first-child[class^=highlight],
div.nboutput > :first-child {
    min-width: 11ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}

/* input/output area */
div.nbinput > :nth-child(2)[class^=highlight],
div.nboutput > :nth-child(2),
div.nboutput > :nth-child(2)[class^=highlight] {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
}

/* input area */
div.nbinput > :nth-child(2)[class^=highlight] {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput  > :nth-child(2).stderr {
    background: #fdd;
}

/* ANSI colors */
.ansiblack { color: black; }
.ansired { color: darkred; }
.ansigreen { color: darkgreen; }
.ansiyellow { color: #c4a000; }
.ansiblue { color: darkblue; }
.ansipurple { color: darkviolet; }
.ansicyan { color: steelblue; }
/* See https://github.com/jupyter/nbconvert/issues/174 */
.ansigray { color: gray; }  /* nbconvert CSS */
.ansigrey { color: gray; }  /* nbconvert HTML output */

.ansibgblack { background-color: black; }
.ansibgred { background-color: red; }
.ansibggreen { background-color: green; }
.ansibgyellow { background-color: yellow; }
.ansibgblue { background-color: blue; }
.ansibgpurple { background-color: magenta; }
.ansibgcyan { background-color: cyan; }
.ansibggray { background-color: gray; }

.ansibold { font-weight: bold; }
</style>
<div class="section" id="automated-deployment-with-ansible">
<h1>Automated Deployment with Ansible<a class="headerlink" href="#automated-deployment-with-ansible" title="Permalink to this headline">¶</a></h1>
<p>Prior to today we&#8217;ve been able to deploy simple web apps to Amazon Web Services.
However, every time we do, it&#8217;s a process.
Any step that we miss can be detrimental and break our deployment.
We may not even always remember which steps to take.</p>
<p>It&#8217;s easier while it&#8217;s fresh in our minds, but what about 6 weeks from now?
How about in 6 months?
Let&#8217;s take that responsibility off of our mental load and automate the process.</p>
<div class="section" id="a-note-about-continuous-delivery-and-dev-ops">
<h2>A Note about Continuous Delivery and Dev Ops<a class="headerlink" href="#a-note-about-continuous-delivery-and-dev-ops" title="Permalink to this headline">¶</a></h2>
<p><strong>Continuous Delivery</strong> or <strong>CD</strong> is the concept of being able to immediately deliver changes to production.
This separates the developer from the direct handling of the deployment process, allowing them to push a button and &#8220;make it so&#8221;.
It&#8217;s oftentimes used as a synonym for <strong>continuous deployment</strong>, which ensures that changes have passed quality assurance tests.</p>
<p>These two, along with <strong>continuous integration</strong> (<strong>CI</strong>), start to push developers into the realm of <strong>Developer Operations</strong>, or <strong>DevOps</strong>.
DevOps engineers spend time focusing on the process for product delivery.
They are the bridge between the software developers who write the production code, and other IT professionals that make sure the code can actually run in production.
Amongst other tools, DevOps engineers use resources like <strong>Ansible</strong> and <strong>Docker</strong> to package and deliver software for the production environment.</p>
</div>
<div class="section" id="introduction-to-ansible">
<h2>Introduction to Ansible<a class="headerlink" href="#introduction-to-ansible" title="Permalink to this headline">¶</a></h2>
<p><strong>Ansible</strong> is a configuration management tool written in Python that, in short, executes a given series of commands on remote machines over <a class="reference external" href="http://searchsecurity.techtarget.com/definition/Secure-Shell">SSH</a>.
While actual usage can get more fancy than that, it is at base a package that runs through a command list, executing those commands wherever it is pointed.
We&#8217;ll be using Ansible to make deployment easier for us, so that we Developers can focus less on the needs of AWS (or wherever we deploy), and more on the code we write.</p>
<div class="section" id="installation">
<h3>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h3>
<p>As with most publicly-available Python packages, you can install Ansible with <code class="docutils literal"><span class="pre">pip</span></code>.
However, <strong>unlike most packages it is only currently available for Python 2.6 and 2.7</strong>.
It also does not like virtual environments (yet).</p>
<p>So, <strong>outside of any environment</strong>, use your system-level <code class="docutils literal"><span class="pre">pip</span></code> to install ansible.</p>
<div class="highlight-bash"><div class="highlight"><pre>$ pip install ansible
</pre></div>
</div>
<p>Upon install, ansible will provide you with <em>several</em> new console scripts:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ansible</span></code></li>
<li><code class="docutils literal"><span class="pre">ansible-console</span></code></li>
<li><code class="docutils literal"><span class="pre">ansible-doc</span></code></li>
<li><code class="docutils literal"><span class="pre">ansible-galaxy</span></code></li>
<li><code class="docutils literal"><span class="pre">ansible-playbook</span></code></li>
<li><code class="docutils literal"><span class="pre">ansible-pull</span></code></li>
<li><code class="docutils literal"><span class="pre">ansible-vault</span></code></li>
</ul>
<p>We&#8217;ll be chiefly concerned with <code class="docutils literal"><span class="pre">ansible</span></code>, <code class="docutils literal"><span class="pre">ansible-playbook</span></code>, and slightly with <code class="docutils literal"><span class="pre">ansible-galaxy</span></code>.
While ansible itself doesn&#8217;t like to be installed within a Python 3 virtual environment,
once it&#8217;s installed at the system level you can use the console scripts anywhere.</p>
<p>Ansible can also be installed and run from a remote server, but we&#8217;ll only need to work with it on our local machines.</p>
<p>Now that we have ansible installed, let&#8217;s create a new working directory and environment for experimenting with it.</p>
<div class="highlight-bash"><div class="highlight"><pre>$ mkdir ansible-test
$ <span class="nb">cd</span> ansible-test
$ python3 -m venv ENV
$ <span class="nb">source</span> ENV/bin/activate
<span class="o">(</span>ENV<span class="o">)</span> $
</pre></div>
</div>
</div>
<div class="section" id="the-simplest-runs">
<h3>The Simplest Runs<a class="headerlink" href="#the-simplest-runs" title="Permalink to this headline">¶</a></h3>
<p>Whenever you run ansible, you run it against a series of servers.
At this point, because we haven&#8217;t created a <code class="docutils literal"><span class="pre">hosts</span></code> file,
ansible will look in <code class="docutils literal"><span class="pre">/etc/ansible/hosts</span></code> for a list of servers to run commands against.</p>
<p>Chances are you don&#8217;t have a file there yet, so let&#8217;s make one.
To start, let&#8217;s have ansible talk to and execute commands on your local machine.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span> $ <span class="nb">echo</span> 127.0.0.1 <span class="nv">ansible_connection</span><span class="o">=</span><span class="nb">local</span> &gt; hosts
<span class="o">(</span>ENV<span class="o">)</span> $ mv hosts /etc/ansible/
</pre></div>
</div>
<p>And now you can run your first ansible command.</p>
<p><code class="docutils literal"><span class="pre">ping</span></code> will attempt to contact every host listed, and return a &#8220;success&#8221; message when it&#8217;s successful.
We can use <code class="docutils literal"><span class="pre">ping</span></code> by typing the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span> $ ansible all -m ping
127.0.0.1 <span class="p">|</span> <span class="nv">SUCCESS</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&quot;changed&quot;</span>: false,
    <span class="s2">&quot;ping&quot;</span>: <span class="s2">&quot;pong&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>We can use the <code class="docutils literal"><span class="pre">-a</span></code> flag to run a live command on each server</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span> $ ansible all -a <span class="s2">&quot;pwd&quot;</span>
127.0.0.1 <span class="p">|</span> SUCCESS <span class="p">|</span> <span class="nv">rc</span><span class="o">=</span><span class="m">0</span> &gt;&gt;
/Users/Nick
</pre></div>
</div>
</div>
<div class="section" id="local-host-not-localhost-inventory-list">
<h3>Local Host (not &#8220;localhost&#8221;) Inventory List<a class="headerlink" href="#local-host-not-localhost-inventory-list" title="Permalink to this headline">¶</a></h3>
<p>You may not want to use the host list at <code class="docutils literal"><span class="pre">/etc/ansible/hosts</span></code>.
You may instead have a local list of servers you want to run commands against.
For this you create an <strong>inventory</strong> file called <code class="docutils literal"><span class="pre">hosts</span></code>, and within that list the servers you want to run commands against.
It&#8217;ll end up looking exactly like what we put into <code class="docutils literal"><span class="pre">/etc/ansible/hosts</span></code></p>
<div class="highlight-shell"><div class="highlight"><pre><span class="c1"># inside hosts</span>
127.0.0.1
</pre></div>
</div>
<p>We can run ansible using this inventory file with the <code class="docutils literal"><span class="pre">-i</span></code> flag.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span> $ ansible -i hosts all -a <span class="s2">&quot;pwd&quot;</span>
127.0.0.1 <span class="p">|</span> SUCCESS <span class="p">|</span> <span class="nv">rc</span><span class="o">=</span><span class="m">0</span> &gt;&gt;
/Users/Nick
</pre></div>
</div>
<p>Now we haven&#8217;t come all this way just to run commands against <code class="docutils literal"><span class="pre">localhost</span></code>.
We&#8217;ve each provisioned our own AWS EC2 Ubuntu instances, complete with private keys that we&#8217;ve saved to the <code class="docutils literal"><span class="pre">~/.ssh/</span></code> directory.
Let&#8217;s put those to use.</p>
<p>Log into your AWS EC2 console and get the Public IP for your instance.
The examples that follow will use one of my own.</p>
<p>In the <code class="docutils literal"><span class="pre">hosts</span></code> file we just made, put the public IP for your instance.</p>
<div class="highlight-shell"><div class="highlight"><pre><span class="c1"># inside hosts</span>
127.0.0.1
35.165.212.243
</pre></div>
</div>
<p>If we try to run ansible as is, it will fail.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span> $ ansible -i hosts all -a <span class="s2">&quot;pwd&quot;</span>
35.165.212.243 <span class="p">|</span> UNREACHABLE! <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&quot;changed&quot;</span>: false,
    <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;Failed to connect to the host via ssh.&quot;</span>,
    <span class="s2">&quot;unreachable&quot;</span>: <span class="nb">true</span>
<span class="o">}</span>
127.0.0.1 <span class="p">|</span> SUCCESS <span class="p">|</span> <span class="nv">rc</span><span class="o">=</span><span class="m">0</span> &gt;&gt;
/Users/Nick
</pre></div>
</div>
<p>Why did it fail?
Remember that ansible tries to reach different servers over SSH.
For our AWS EC2 instances, we need two things in order to reach that remote address:</p>
<ul class="simple">
<li>The remote user</li>
<li>The AWS private key</li>
</ul>
<p>We haven&#8217;t yet provided these, and so we fail to connect over ssh.
We can add these in by specifying the <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code> and <code class="docutils literal"><span class="pre">ansible_ssh_private_key_file</span></code> <strong>host variables</strong> in the <code class="docutils literal"><span class="pre">hosts</span></code> file.
Because the &#8220;user&#8221; that we use to ssh into AWS is <code class="docutils literal"><span class="pre">ubuntu</span></code>, we set that as our <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code>.
Our private key file was provided to us once (and only once) by AWS and should have been saved somewhere consistent like the <code class="docutils literal"><span class="pre">~/.ssh/</span></code> directory.
Let&#8217;s use this knowledge to properly set up our <code class="docutils literal"><span class="pre">hosts</span></code> file.</p>
<div class="highlight-shell"><div class="highlight"><pre><span class="c1"># inside hosts</span>
127.0.0.1 <span class="nv">ansible_connection</span><span class="o">=</span><span class="nb">local</span>
35.165.212.243 <span class="nv">ansible_ssh_user</span><span class="o">=</span>ubuntu <span class="nv">ansible_ssh_private_key_file</span><span class="o">=</span>~/.ssh/pk-aws.pem
</pre></div>
</div>
<p>Now when we run that same ansible command, it&#8217;ll run <code class="docutils literal"><span class="pre">pwd</span></code> on our local machine as well as on our remote AWS server.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span> $ ansible -i hosts all -a <span class="s2">&quot;pwd&quot;</span>
127.0.0.1 <span class="p">|</span> SUCCESS <span class="p">|</span> <span class="nv">rc</span><span class="o">=</span><span class="m">0</span> &gt;&gt;
/Users/Nick

35.165.212.243 <span class="p">|</span> SUCCESS <span class="p">|</span> <span class="nv">rc</span><span class="o">=</span><span class="m">0</span> &gt;&gt;
/home/ubuntu
</pre></div>
</div>
<p>If we have multiple hosts that all use the same variables, or have multiple hosts that we want to run a given set of commands against, we can create <strong>host groups</strong>.
You can name these groups more-or-less whatever you want, as long as you encase the name in square brackets (INI style).</p>
<div class="highlight-shell"><div class="highlight"><pre><span class="c1"># inside hosts</span>
<span class="o">[</span>us-west-2<span class="o">]</span>
35.165.212.243

<span class="o">[</span>us-west-2:vars<span class="o">]</span>
<span class="nv">ansible_ssh_user</span><span class="o">=</span>ubuntu
<span class="nv">ansible_ssh_private_key_file</span><span class="o">=</span>~/.ssh/pk-aws.pem
</pre></div>
</div>
</div>
</div>
<div class="section" id="ansible-playbooks">
<h2>Ansible Playbooks<a class="headerlink" href="#ansible-playbooks" title="Permalink to this headline">¶</a></h2>
<p>Being able to run individual commands like <code class="docutils literal"><span class="pre">pwd</span></code> or <code class="docutils literal"><span class="pre">ping</span></code> is all well and good,
but not very useful in the long run.
We use the &#8220;ansible&#8221; tool to automate a whole series of actions.
That&#8217;s it&#8217;s purpose.
To get a series of commands to run, we use a <strong>playbook</strong>.</p>
<p>Every playbook that you write will be in <a class="reference external" href="http://docs.ansible.com/ansible/YAMLSyntax.html">YAML style</a>, with the <code class="docutils literal"><span class="pre">.yml</span></code> file format.
It ends up just being a bunch of key-value pairs, specifying the various parameters you need to run ansible.
Dashes set up a list-like object, and indentation levels dictate structure.</p>
<p>Start by creating a <code class="docutils literal"><span class="pre">playbooks</span></code> directory.
Adding to it your first playbook <code class="docutils literal"><span class="pre">sample_playbook.yml</span></code>, with a list of one element.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># inside sample_playbook.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
  <span class="l l-Scalar l-Scalar-Plain">remote_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
</pre></div>
</div>
<p>We specify which hosts we want to run commands against.
We can use individual hosts, or we can use host group names.
Either way, we can have one or many.
Above I&#8217;m using the <code class="docutils literal"><span class="pre">us-west-2</span></code> group name.
I also specify the <code class="docutils literal"><span class="pre">remote_user</span></code> that we will be logged in as.</p>
<p>What we&#8217;ve begun above is the first item in a list of <strong>plays</strong>.
Each <strong>play</strong> targets a set of hosts, and runs commands on that host.
This we&#8217;ll use just one play, which will consist of multiple <strong>tasks</strong>.
Let&#8217;s hear about these next.</p>
<div class="section" id="tasks">
<h3>Tasks<a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h3>
<p>Tasks are as they sound&#8211;actions for ansible to perform on the remote host.
Previously we used the <code class="docutils literal"><span class="pre">ansible</span></code> command-line script to just do one thing.
Now we&#8217;ll use a playbook to do multiple things.</p>
<p>Tasks come as a list in order from top to bottom, and are always run in order.
If for any reason a task is unsuccessful, ansible will throw an error and stop the play.</p>
<p>Tasks should start with a <code class="docutils literal"><span class="pre">name</span></code>.
This <code class="docutils literal"><span class="pre">name</span></code> can be just about whatever you want, but should be descriptive of the task being executed.</p>
<p><strong>Modules</strong> actually execute the tasks.
There are <a class="reference external" href="http://docs.ansible.com/ansible/modules_by_category.html">a wide array of modules</a> baked in to ansible.
However if you don&#8217;t see one or know of one that&#8217;s useful for your specific task,
you can use the <code class="docutils literal"><span class="pre">command</span></code> module.
It&#8217;ll run the <code class="docutils literal"><span class="pre">bash</span></code> command as you write it.</p>
<p>Let&#8217;s write our first task.
In <code class="docutils literal"><span class="pre">playbooks/sample_playbook.yml</span></code>, have the following code.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># inside sample_playbook.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
  <span class="l l-Scalar l-Scalar-Plain">remote_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Run the &quot;ls -a&quot; command to see what&#39;s in the home directory</span>
      <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ls -a</span>
</pre></div>
</div>
<p>To run playbooks we use the <code class="docutils literal"><span class="pre">ansible-playbook</span></code> console script.
Just like the bare <code class="docutils literal"><span class="pre">ansible</span></code> command, we use our local list of hosts with the <code class="docutils literal"><span class="pre">-i</span></code> flag.
We point the <code class="docutils literal"><span class="pre">ansible-playbook</span></code> script at the <code class="docutils literal"><span class="pre">sample_playbook.yml</span></code> file we just edited.
When we run <code class="docutils literal"><span class="pre">ansible-playbook</span></code>, it should look something like this (but with color).</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span> $ ansible-playbook -i hosts playbooks/sample_playbook.yml

PLAY <span class="o">[</span>us-west-2<span class="o">]</span> ***************************************************************

TASK <span class="o">[</span>setup<span class="o">]</span> *******************************************************************
ok: <span class="o">[</span>35.165.212.243<span class="o">]</span>

TASK <span class="o">[</span>Run the ls command<span class="o">]</span> ******************************************************
changed: <span class="o">[</span>35.165.212.243<span class="o">]</span>

PLAY RECAP *********************************************************************
35.165.212.243             : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</pre></div>
</div>
<p>When a playbook is run, ansible first checks to see that it can contact the host.
After setting up a connection to the host, it runs the tasks that we&#8217;ve set out.
Here it ran the <code class="docutils literal"><span class="pre">ls</span></code> command, though as we&#8217;ve run the script above we don&#8217;t see the output.
When the playbook is finished, it gives you a summary of what was done.
Every time something was changed on the remote host, the status after the command was run is <code class="docutils literal"><span class="pre">changed</span></code>, etc.</p>
<p>If we want the actual output from the <code class="docutils literal"><span class="pre">ls</span> <span class="pre">-a</span></code> command we ran on our remote host,
we need to change how verbose our output is with the <code class="docutils literal"><span class="pre">-v</span></code> flag.
This flag is entirely optional.
<code class="docutils literal"><span class="pre">-v</span></code> is the first level of verbosity, <code class="docutils literal"><span class="pre">-vv</span></code> is a little more verbose, and <code class="docutils literal"><span class="pre">-vvv</span></code> is very verbose, telling you everything that ansible is doing (whether you want that info or not).</p>
<p>Run the <code class="docutils literal"><span class="pre">ansible-playbook</span></code> command with <code class="docutils literal"><span class="pre">-v</span></code> and check the output.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span> $ ansible-playbook -i hosts playbooks/sample_playbook.yml -v
No config file found<span class="p">;</span> using defaults

PLAY <span class="o">[</span>us-west-2<span class="o">]</span> ***************************************************************

TASK <span class="o">[</span>setup<span class="o">]</span> *******************************************************************
ok: <span class="o">[</span>35.165.212.243<span class="o">]</span>

TASK <span class="o">[</span>Run the ls command<span class="o">]</span> ******************************************************
changed: <span class="o">[</span>35.165.212.243<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">{</span><span class="s2">&quot;changed&quot;</span>: true, <span class="s2">&quot;cmd&quot;</span>: <span class="o">[</span><span class="s2">&quot;ls&quot;</span>, <span class="s2">&quot;-a&quot;</span><span class="o">]</span>, <span class="s2">&quot;delta&quot;</span>: <span class="s2">&quot;0:00:00.001853&quot;</span>, <span class="s2">&quot;end&quot;</span>: <span class="s2">&quot;2016-12-28 06:51:35.633423&quot;</span>, <span class="s2">&quot;rc&quot;</span>: 0, <span class="s2">&quot;start&quot;</span>: <span class="s2">&quot;2016-12-28 06:51:35.631570&quot;</span>, <span class="s2">&quot;stderr&quot;</span>: <span class="s2">&quot;&quot;</span>, <span class="s2">&quot;stdout&quot;</span>: <span class="s2">&quot;.\n..\n.ansible\n.bash_history\n.bash_logout\n.bashrc\nbookapp\n.cache\nmyapp.py\n.pip\n.profile\n.python_history\n.ssh&quot;</span>, <span class="s2">&quot;stdout_lines&quot;</span>: <span class="o">[</span><span class="s2">&quot;.&quot;</span>, <span class="s2">&quot;..&quot;</span>, <span class="s2">&quot;.ansible&quot;</span>, <span class="s2">&quot;.bash_history&quot;</span>, <span class="s2">&quot;.bash_logout&quot;</span>, <span class="s2">&quot;.bashrc&quot;</span>, <span class="s2">&quot;bookapp&quot;</span>, <span class="s2">&quot;.cache&quot;</span>, <span class="s2">&quot;myapp.py&quot;</span>, <span class="s2">&quot;.pip&quot;</span>, <span class="s2">&quot;.profile&quot;</span>, <span class="s2">&quot;.python_history&quot;</span>, <span class="s2">&quot;.ssh&quot;</span><span class="o">]</span>, <span class="s2">&quot;warnings&quot;</span>: <span class="o">[]}</span>

PLAY RECAP *********************************************************************
35.165.212.243             : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</pre></div>
</div>
<p>Here, ansible ran the <code class="docutils literal"><span class="pre">ls</span> <span class="pre">-a</span></code> command and the output is captured in <code class="docutils literal"><span class="pre">stdout_lines</span></code> as a list.
Your output will look different than mine above, but we&#8217;ll fix that in a bit.</p>
<div class="section" id="apt-module-and-looping">
<h4>apt Module and Looping<a class="headerlink" href="#apt-module-and-looping" title="Permalink to this headline">¶</a></h4>
<p>During the manual deployment, one of the first things needing to be done was an update of the Ubuntu system.
This was accomplished with <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">update</span></code>.
We don&#8217;t need to run the bare bash command to use <code class="docutils literal"><span class="pre">apt-get</span></code> though, we can use ansible&#8217;s own <code class="docutils literal"><span class="pre">apt</span></code> module.</p>
<p>The <a class="reference external" href="http://docs.ansible.com/ansible/apt_module.html">apt module</a> accesses the <code class="docutils literal"><span class="pre">apt</span></code> package manager on the Ubuntu system.
To update the system, we can pass in the <code class="docutils literal"><span class="pre">update_cache=yes</span></code> parameter.
Finally, because we need to do this as the &#8220;superuser&#8221;, we need ansible to become the superuser and execute the command.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># inside sample_playbook.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
  <span class="l l-Scalar l-Scalar-Plain">remote_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Update the Ubuntu system and services</span>
      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">update_cache=yes</span>
      <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span> $ ansible-playbook -i hosts playbooks/sample_playbook.yml -v
No config file found<span class="p">;</span> using defaults

PLAY <span class="o">[</span>us-west-2<span class="o">]</span> ***************************************************************

TASK <span class="o">[</span>setup<span class="o">]</span> *******************************************************************
ok: <span class="o">[</span>35.165.212.243<span class="o">]</span>

TASK <span class="o">[</span>Update the Ubuntu system and services<span class="o">]</span> ***********************************
ok: <span class="o">[</span>35.165.212.243<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">{</span><span class="s2">&quot;cache_update_time&quot;</span>: 1482908590, <span class="s2">&quot;cache_updated&quot;</span>: true, <span class="s2">&quot;changed&quot;</span>: false<span class="o">}</span>

PLAY RECAP *********************************************************************
35.165.212.243             : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</pre></div>
</div>
<p>If <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">update</span></code> has already been run, then nothing will change.
The system above was already updated, so even though the command was run there was nothing to change.
In general, ansible commands are <strong>idempotent</strong>, where <strong>they won&#8217;t change the state of the system if the intended state has already been reached</strong>.</p>
<p>If we&#8217;re working with a fresh system, we need to install a number of other services in order to get our site up and running:</p>
<ul class="simple">
<li>nginx</li>
<li>python3</li>
<li>python3-pip</li>
<li>python3.4-venv</li>
<li>git</li>
<li>gunicorn</li>
</ul>
<p>We could get each individual one with a series of tasks that run <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">&lt;service&gt;</span></code>.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># inside sample_playbook.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
  <span class="l l-Scalar l-Scalar-Plain">remote_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Update the Ubuntu system and services</span>
      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">update_cache=yes</span>
      <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install Nginx</span>
      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name=nginx state=latest</span>
      <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install Python 3</span>
      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name=python3 state=latest</span>
      <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install pip for Python 3</span>
      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name=python3-pip state=latest</span>
      <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>

    <span class="l l-Scalar l-Scalar-Plain">... and on and on</span>
</pre></div>
</div>
<p>However, we could be better programmers and keep even this playbook DRY.
First, since we know we&#8217;re going to become the superuser a lot, we could just run
every command as the superuser.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># inside sample_playbook.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
  <span class="l l-Scalar l-Scalar-Plain">remote_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span> <span class="c1"># and now list the tasks out as before</span>
</pre></div>
</div>
<p>I tend to not do the above, as I only like using <code class="docutils literal"><span class="pre">sudo</span></code> when I absolutely need it.
However it&#8217;s justifiable here, as we&#8217;re managing packages, editing config files, etc.</p>
<p>Second, we can use a variable whose value will be the name of each package.
We can then list out the packages we want to install within that task.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># inside sample_playbook.yml</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
  <span class="l l-Scalar l-Scalar-Plain">remote_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Update the Ubuntu system and services</span>
      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">update_cache=yes</span>
      <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install Basic Unix-level Services</span>
      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name={{ item }} state=latest</span>
      <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
      <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python3</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python3-pip</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python3.4-venv</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">git</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">gunicorn</span>
</pre></div>
</div>
<p>The above task will loop through the given items and put each in the place of &#8220;item&#8221;.
Ansible uses Jinja2-style templating for declaring variables.
We&#8217;ll see more of this later.</p>
<p>If each item was a list of values, then we&#8217;d use <code class="docutils literal"><span class="pre">{{</span> <span class="pre">item[0]</span> <span class="pre">}}</span></code>, <code class="docutils literal"><span class="pre">{{</span> <span class="pre">item[1]</span> <span class="pre">}}</span></code>, etc. to get every element.
If instead every item was a dictionary, then we&#8217;d use <code class="docutils literal"><span class="pre">{{</span> <span class="pre">item.key1</span> <span class="pre">}}</span></code>, <code class="docutils literal"><span class="pre">{{</span> <span class="pre">item.key2</span> <span class="pre">}}</span></code>, etc. to get the value of every key-value pair.</p>
<p>When the playbook is run in the command line with the &#8220;verbose&#8221; flag we get a bunch of output.
Like...a ton, so be careful.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span> $ ansible-playbook -i hosts playbooks/sample_playbook.yml

PLAY <span class="o">[</span>us-west-2<span class="o">]</span> ***************************************************************

TASK <span class="o">[</span>setup<span class="o">]</span> *******************************************************************
ok: <span class="o">[</span>35.165.212.243<span class="o">]</span>

TASK <span class="o">[</span>Update the Ubuntu system and services<span class="o">]</span> ***********************************
ok: <span class="o">[</span>35.165.212.243<span class="o">]</span>

TASK <span class="o">[</span>Install Basic Unix-level Services<span class="o">]</span> ***************************************
changed: <span class="o">[</span>35.165.212.243<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=[</span>u<span class="s1">&#39;nginx&#39;</span>, u<span class="s1">&#39;python3&#39;</span>, u<span class="s1">&#39;python3-pip&#39;</span>, u<span class="s1">&#39;python3.4-venv&#39;</span>, u<span class="s1">&#39;git&#39;</span>, u<span class="s1">&#39;gunicorn&#39;</span><span class="o">])</span>

PLAY RECAP *********************************************************************
35.165.212.243             : <span class="nv">ok</span><span class="o">=</span><span class="m">3</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</pre></div>
</div>
</div>
<div class="section" id="the-git-module">
<h4>The git Module<a class="headerlink" href="#the-git-module" title="Permalink to this headline">¶</a></h4>
<p>We can use the <a class="reference external" href="http://docs.ansible.com/ansible/git_module.html">git module</a> to clone an app onto our remote system like we would any other computer.
We provide <code class="docutils literal"><span class="pre">git</span></code> with the repo url as well as the path to where this repository should be cloned.</p>
<p>We&#8217;re going to use <a class="reference external" href="https://github.com/cewing/simple-bookapp">this simple book app</a> as our example application.
We&#8217;ll clone it into our &#8220;home&#8221; directory and just call it &#8220;bookapp&#8221;.
To do this, we&#8217;ll add the following task</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># at the bottom of sample_playbook.yml</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Clone the Book App to the Home Directory</span>
  <span class="l l-Scalar l-Scalar-Plain">git</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">clone=yes repo=https://github.com/cewing/simple-bookapp.git dest=/home/ubuntu/bookapp</span>
</pre></div>
</div>
<p>Be aware that when ansible sees <code class="docutils literal"><span class="pre">~</span></code>, it uses it to mean <code class="docutils literal"><span class="pre">/root</span></code>.
We shouldn&#8217;t be working in the <code class="docutils literal"><span class="pre">/root</span></code> directory, so make sure to provide the path to the home directory on your instance.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&#8220;git&#8221; is entirely independent of the &#8220;GitHub&#8221; company. It is just the commonly-used version control system, and exists in multiple forms. As long as you have the URL to a remote repository, whether it&#8217;s on GitHub, BitBucket, GitLab, etc., you can clone a remote repository.</p>
</div>
<p>Now we rerun our playbook.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ENV<span class="o">)</span> $ ansible-playbook -i hosts playbooks/sample_playbook.yml -v

<span class="c1"># all the old output</span>

TASK <span class="o">[</span>Clone the Book App to the Home Directory<span class="o">]</span> ********************************
changed: <span class="o">[</span>35.165.212.243<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">{</span><span class="s2">&quot;after&quot;</span>: <span class="s2">&quot;79bda0988147d88d25217a46b361742e29ea6a92&quot;</span>, <span class="s2">&quot;before&quot;</span>: null, <span class="s2">&quot;changed&quot;</span>: true, <span class="s2">&quot;warnings&quot;</span>: <span class="o">[]}</span>

PLAY RECAP *********************************************************************
35.165.212.243             : <span class="nv">ok</span><span class="o">=</span><span class="m">4</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</pre></div>
</div>
</div>
<div class="section" id="virtual-environments-and-the-pip-module">
<h4>Virtual Environments and The pip Module<a class="headerlink" href="#virtual-environments-and-the-pip-module" title="Permalink to this headline">¶</a></h4>
<p>As we do on our local machines we can do our Python work in a virtual environment.
We have to, of course, make one first.</p>
<p>We can use the <code class="docutils literal"><span class="pre">command</span></code> module to run our classic virtual environment creation.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># at the bottom of sample_playbook.yml</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create a virtual environment in the book app repo</span>
  <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">python3 -m venv /home/ubuntu/bookapp</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
</pre></div>
</div>
<p>Then we can use <code class="docutils literal"><span class="pre">pip</span></code> to install the <code class="docutils literal"><span class="pre">gunicorn</span></code> Python package, as well as this individual <code class="docutils literal"><span class="pre">bookapp</span></code> package.
Instead of using pip from the command line, we can use ansible&#8217;s <code class="docutils literal"><span class="pre">pip</span></code> module.</p>
<p><code class="docutils literal"><span class="pre">pip</span></code> will at the very least take the <code class="docutils literal"><span class="pre">name</span></code> parameter.
The value attached to this parameter needs to be the name of an installable package from the Python Package Index, or the path to a local distribution.</p>
<p>As an option you can provide the path to an existing virtual environment.
What qualifies is a directory containing the <code class="docutils literal"><span class="pre">bin</span></code> and <code class="docutils literal"><span class="pre">lib</span></code> directories.
Above we created a virtual environment in our <code class="docutils literal"><span class="pre">bookapp</span></code> repo so we can use that one.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># at the bottom of sample_playbook.yml</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install gunicorn to the virtualenv</span>
  <span class="l l-Scalar l-Scalar-Plain">pip</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">virtualenv=/home/ubuntu/bookapp name=gunicorn</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install bookapp to the virtualenv</span>
  <span class="l l-Scalar l-Scalar-Plain">pip</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">virtualenv=/home/ubuntu/bookapp name=/home/ubuntu/bookapp/ extra_args=&quot;-e&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
</pre></div>
</div>
<p>Rerun the playbook using the verbose flag and see that these tasks ran successfully.</p>
</div>
</div>
</div>
<div class="section" id="templates-and-configuring-nginx">
<h2>Templates and Configuring Nginx<a class="headerlink" href="#templates-and-configuring-nginx" title="Permalink to this headline">¶</a></h2>
<p>During our manual deployment we had to perform several steps to get Nginx up and running.
Let&#8217;s do that with ansible.</p>
<p>Recall that on a fresh system, there&#8217;s a file called <code class="docutils literal"><span class="pre">default</span></code> within the <code class="docutils literal"><span class="pre">/etc/nginx/sites-available</span></code> directory.
This file is what the <code class="docutils literal"><span class="pre">nginx</span></code> service uses to set up a proxy server to stand between your web app and the internet.</p>
<p>We can use ansible to change that file&#8217;s name so that we can use the <code class="docutils literal"><span class="pre">default</span></code> name for our own Nginx configuration.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Rename old default file</span>
  <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mv /etc/nginx/sites-available/default /etc/nginx/sites-available/default.old</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
</pre></div>
</div>
<p>However, this comes with a problem.
This task is not idempotent.
This means that if we try to run our playbook again, we&#8217;ll get the following failure message</p>
<div class="highlight-bash"><div class="highlight"><pre>TASK <span class="o">[</span>Rename old default file<span class="o">]</span> ***************************************************
fatal: <span class="o">[</span>35.165.212.243<span class="o">]</span>: FAILED! <span class="o">=</span>&gt; <span class="o">{</span><span class="s2">&quot;changed&quot;</span>: true, <span class="s2">&quot;cmd&quot;</span>: <span class="o">[</span><span class="s2">&quot;mv&quot;</span>, <span class="s2">&quot;/etc/nginx/sites-available/default&quot;</span>, <span class="s2">&quot;/etc/nginx/sites-available/default.old&quot;</span><span class="o">]</span>, <span class="s2">&quot;delta&quot;</span>: <span class="s2">&quot;0:00:00.002064&quot;</span>, <span class="s2">&quot;end&quot;</span>: <span class="s2">&quot;2016-12-28 21:52:38.818380&quot;</span>, <span class="s2">&quot;failed&quot;</span>: true, <span class="s2">&quot;rc&quot;</span>: 1, <span class="s2">&quot;start&quot;</span>: <span class="s2">&quot;2016-12-28 21:52:38.816316&quot;</span>, <span class="s2">&quot;stderr&quot;</span>: <span class="s2">&quot;mv: cannot stat ‘/etc/nginx/sites-available/default’: No such file or directory&quot;</span>, <span class="s2">&quot;stdout&quot;</span>: <span class="s2">&quot;&quot;</span>, <span class="s2">&quot;stdout_lines&quot;</span>: <span class="o">[]</span>, <span class="s2">&quot;warnings&quot;</span>: <span class="o">[]}</span>
</pre></div>
</div>
<p>We need to be able to make different decisions about what to do based on the existence or nonexistence of a file.</p>
<div class="section" id="file-status">
<h3>File Status<a class="headerlink" href="#file-status" title="Permalink to this headline">¶</a></h3>
<p>Ansible allows us to create tasks that simply look for files and register their statuses.
These tasks use the <a class="reference external" href="http://docs.ansible.com/ansible/stat_module.html">stat module</a>, and we can register that status as an in-playbook variable.</p>
<p>The <code class="docutils literal"><span class="pre">stat</span></code> module will tell you whether or not a file exists, how large that file is, whether or not it&#8217;s executable, readable, writeable, whether or not it&#8217;s a directory, and a host of other information.</p>
<p>We can use that information as the basis for our decision-making.</p>
<p>Write this next task above the previous task that changes the <code class="docutils literal"><span class="pre">default</span></code> file&#8217;s name.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Register the old default file</span>
  <span class="l l-Scalar l-Scalar-Plain">stat</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">path=/etc/nginx/sites-available/default.old</span>
  <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default_stat</span>
</pre></div>
</div>
<p>We register the result of this task as <code class="docutils literal"><span class="pre">default_stat</span></code>.
We can now use this result in the name-change task.</p>
</div>
<div class="section" id="conditionals">
<h3>Conditionals<a class="headerlink" href="#conditionals" title="Permalink to this headline">¶</a></h3>
<p>Conditional statements in ansible aren&#8217;t their own standalone tasks.
They come in as conditions on other tasks.
It reads a little like english: &#8220;Do &lt;task name&gt; <strong>when</strong> &lt;condition&gt;&#8221;.</p>
<p>We add a condition to our renaming task using the <code class="docutils literal"><span class="pre">when</span></code> statement.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Rename old default file if a copy doesn&#39;t already exist</span>
  <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mv /etc/nginx/sites-available/default /etc/nginx/sites-available/default.old</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
  <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">not default_stat.stat.exists</span> <span class="c1"># &lt;-- this is the only line that should be added.</span>
</pre></div>
</div>
<p>Our conditionals should all be Python-like.
That means you can do comparisons with <code class="docutils literal"><span class="pre">=,</span> <span class="pre">&lt;,</span> <span class="pre">&gt;</span></code> and take negation.
You can check if conditions are <code class="docutils literal"><span class="pre">True</span></code> or not, etc.</p>
<p>The <code class="docutils literal"><span class="pre">.exists</span></code> attribute on the <code class="docutils literal"><span class="pre">stat</span></code> result simply returns a boolean; <code class="docutils literal"><span class="pre">True</span></code> if the path given exists and <code class="docutils literal"><span class="pre">False</span></code> if it doesn&#8217;t.
The above task then only runs if the condition is met (<code class="docutils literal"><span class="pre">default.old</span></code> exists, so there is no <code class="docutils literal"><span class="pre">default</span></code> file to move).</p>
<p>We can now run our playbook as many times as we like, safe in the knowledge that if the system is fresh we make the appropriate change, and if the system has already been altered then the change isn&#8217;t even considered.</p>
<p>Indeed, when our playbook is run, we see the following lines</p>
<div class="highlight-bash"><div class="highlight"><pre>TASK [Register the old default file] *******************************************
ok: [35.165.212.243]

TASK [Rename old default file if a copy doesn&#39;t already exist] *****************
skipping: [35.165.212.243]
</pre></div>
</div>
</div>
<div class="section" id="ansible-templates">
<h3>Ansible Templates<a class="headerlink" href="#ansible-templates" title="Permalink to this headline">¶</a></h3>
<p>At this step in our process, we need to copy over our new <code class="docutils literal"><span class="pre">default</span></code> file to use for Nginx&#8217;s configuration.
Now, we could always just include this file with our package and move it to a new location after we clone.
However a problem arises, because certain values will need to change depending upon the system being used.</p>
<p>Even for our simplest setup, we have to tie the <code class="docutils literal"><span class="pre">server_name</span></code> attribute to the name of the actual server we&#8217;re using.
If we want a different <code class="docutils literal"><span class="pre">proxy_pass</span></code> for a given machine, we have to change that too.
Maybe we want to serve over HTTP on some machines and HTTPS on others, meaning we&#8217;d have to change the port that Nginx is listening on.</p>
<p>Instead of constantly conjuring up new variants of an existing file, we can use a <strong>template</strong> file and fill in the necessary information as-needed.</p>
<p>Ansible&#8217;s templating system works off of Jinja2-style templates.
Instead of being tied strictly to HTML, ansible&#8217;s templates generate whatever type of file you want as plain text.
When it&#8217;s time for action, you can declare the file type as well as the location for where this file is being placed in the remote system.</p>
<p>To start, create a directory called <code class="docutils literal"><span class="pre">templates</span></code> at the same level as your <code class="docutils literal"><span class="pre">playbooks</span></code> directory.</p>
<p>From our manual deployment, our <code class="docutils literal"><span class="pre">default</span></code> file for Nginx looked something like this:</p>
<div class="highlight-shell"><div class="highlight"><pre>server <span class="o">{</span>
    listen 80<span class="p">;</span>
    server_name ec2-35-165-212-243.us-west-2.compute.amazonaws.com<span class="p">;</span>
    access_log /var/log/nginx/test.log<span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://127.0.0.1:8080<span class="p">;</span>
        proxy_set_header Host $host<span class="p">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="p">;</span>
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Here, we want to be able to change the <code class="docutils literal"><span class="pre">server_name</span></code> attribute to be whatever we want.</p>
<p>Create a new file in your templates directory called <code class="docutils literal"><span class="pre">nginx_config.jinja2</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible template files don&#8217;t necessarily have to have <em>any</em> file format. Adding one is more for your own comfortability than for the system.</p>
</div>
<p>Inside of <code class="docutils literal"><span class="pre">nginx_config.jinja2</span></code>, paste all of the same code from your <code class="docutils literal"><span class="pre">default</span></code> file.
On the <code class="docutils literal"><span class="pre">server_name</span></code> line, remove whatever server DNS you provided and in its place write <code class="docutils literal"><span class="pre">{{</span> <span class="pre">server_dns</span> <span class="pre">}}</span></code>.
Your template should now look like this:</p>
<div class="highlight-shell"><div class="highlight"><pre>server <span class="o">{</span>
    listen 80<span class="p">;</span>
    server_name <span class="o">{{</span> server_dns <span class="o">}}</span><span class="p">;</span>
    access_log /var/log/nginx/test.log<span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://127.0.0.1:8080<span class="p">;</span>
        proxy_set_header Host $host<span class="p">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="p">;</span>
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="section" id="variables">
<h4>Variables<a class="headerlink" href="#variables" title="Permalink to this headline">¶</a></h4>
<p>Now that we&#8217;ve created a space to be filled with a variable, we need to create the variable.</p>
<p>Ansible variables can come from a variety of sources.
You can set up variables in your inventory file for each individual host, or for a group of hosts.
We&#8217;ve already done that by setting the <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code> and <code class="docutils literal"><span class="pre">ansible_ssh_private_key_file</span></code> variables.</p>
<p>Variables can be defined in the playbook itself at the top of the file, with the same indentation level as <code class="docutils literal"><span class="pre">hosts</span></code>, <code class="docutils literal"><span class="pre">tasks</span></code>, and <code class="docutils literal"><span class="pre">remote_user</span></code>.
The keyword is <code class="docutils literal"><span class="pre">vars</span></code> and it might look like this:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
  <span class="l l-Scalar l-Scalar-Plain">remote_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
  <span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">server_dns</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ec2-35-165-212-243.us-west-2.compute.amazonaws.com</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="c1"># all the tasks</span>
</pre></div>
</div>
<p>Variables can even be defined in entirely separate files and included in your playbook.
That is, however, a separate discussion and I leave you to <a class="reference external" href="http://docs.ansible.com/ansible/playbooks_roles.html#roles">these docs on playbook roles</a>.</p>
<p>I prefer to declare a variable for a simple playbook like ours in the inventory file.
So I declare the <code class="docutils literal"><span class="pre">server_dns</span></code> variable under the <code class="docutils literal"><span class="pre">[us-west-2:vars]</span></code> heading:</p>
<div class="highlight-shell"><div class="highlight"><pre><span class="o">[</span>us-west-2<span class="o">]</span>
35.165.212.243

<span class="o">[</span>us-west-2:vars<span class="o">]</span>
<span class="nv">ansible_ssh_user</span><span class="o">=</span>ubuntu
<span class="nv">ansible_ssh_private_key_file</span><span class="o">=</span>~/.ssh/pk-aws.pem
<span class="nv">server_dns</span><span class="o">=</span>ec2-35-165-212-243.us-west-2.compute.amazonaws.com
</pre></div>
</div>
<p>Finally, with my template created and my variable to fill that template declared, I can write a task that uses it.
The <a class="reference external" href="http://docs.ansible.com/ansible/template_module.html">template module</a> handles the filling and placing of templates on remote systems.
It takes two required parameters: <code class="docutils literal"><span class="pre">src</span></code> and <code class="docutils literal"><span class="pre">dest</span></code>, though you may decide you want to specify other parameters depending on the type of file you&#8217;re trying to create.</p>
<p>The <code class="docutils literal"><span class="pre">src</span></code> parameter will take a path, either relative or absolute, to the template file on our <strong>local</strong> machine.
Ours is sitting in our <code class="docutils literal"><span class="pre">templates</span></code> directory at the relative path <code class="docutils literal"><span class="pre">../templates/nginx_config.jinja2</span></code>.</p>
<p>The <code class="docutils literal"><span class="pre">dest</span></code> parameter also takes a path, pointing to the spot on the <strong>remote</strong> machine where we wish to place this new file, including its new file name.
Our <code class="docutils literal"><span class="pre">default</span></code> file belongs in <code class="docutils literal"><span class="pre">/etc/nginx/sites-available/</span></code>, so the full path provided to <code class="docutils literal"><span class="pre">dest</span></code> will be <code class="docutils literal"><span class="pre">/etc/nginx/sites-available/default</span></code>.</p>
<p>Because the <code class="docutils literal"><span class="pre">/etc/</span></code> directory changes system configuration, a <code class="docutils literal"><span class="pre">sudo</span></code>-enabled action is required.
With all of the above in mind, our task will be</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Create a new default file for nginx</span>
  <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">src=../templates/nginx_config.jinja2 dest=/etc/nginx/sites-available/default</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
</pre></div>
</div>
<p>Note that the above task is <strong>not</strong> conditional on whether or not there&#8217;s an old <code class="docutils literal"><span class="pre">default</span></code> file.
It will overwrite whatever currently sits at that destination path.</p>
</div>
</div>
<div class="section" id="services">
<h3>Services<a class="headerlink" href="#services" title="Permalink to this headline">¶</a></h3>
<p><strong>Services</strong> are effectively applications that the Unix system runs, and aren&#8217;t necessarily associated with Python.
We installed a list of services at the start of this playbook, which included such useful items as <code class="docutils literal"><span class="pre">git</span></code> and <code class="docutils literal"><span class="pre">nginx</span></code>.</p>
<p>For many installed services, we often have to start the service up after it&#8217;s been gathered.
In order to interact with services that aren&#8217;t already built-in to Ansible like Git, we need to use the <a class="reference external" href="http://docs.ansible.com/ansible/service_module.html">service module</a>.</p>
<p>For our purposes, we&#8217;ll mostly use the <code class="docutils literal"><span class="pre">service</span></code> module to stop and start services.
During our manual deployment, we restarted Nginx after swapping out the <code class="docutils literal"><span class="pre">default</span></code> file.
We&#8217;ll have ansible do the same, giving it superuser status so that it may change this service which operates at the system level.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Restart nginx service</span>
  <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name=nginx state=restarted</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="getting-moving-with-upstart-and-gunicorn">
<h2>Getting Moving with Upstart and Gunicorn<a class="headerlink" href="#getting-moving-with-upstart-and-gunicorn" title="Permalink to this headline">¶</a></h2>
<p>After running the playbook to this point, we could ssh into our remote servers and start our applications manually.
But that&#8217;s undoubtedly foolish; we shouldn&#8217;t need to maintain a constant connection in order for our app to work.</p>
<p>We tie the startup of our app to the startup of our server with <code class="docutils literal"><span class="pre">Upstart</span></code>.
We can get it going in a similar way to which we got Nginx going:</p>
<ul class="simple">
<li>Create a template for our upstart configuration script</li>
<li>Copy the template over to the right location (which creates a service for the Unix system to manage)</li>
<li>Start up the new service we&#8217;ve created.</li>
</ul>
<p>Our template <code class="docutils literal"><span class="pre">upstart_config</span></code> will be simple:</p>
<div class="highlight-shell"><div class="highlight"><pre>description <span class="s2">&quot;sample bookapp&quot;</span>

start on <span class="o">(</span>filesystem<span class="o">)</span>
stop on runlevel <span class="o">[</span>016<span class="o">]</span>

respawn
setuid nobody
setgid nogroup
chdir /home/ubuntu/bookapp/src/

<span class="nb">exec</span> /home/ubuntu/bookapp/bin/gunicorn -b :8080 bookapp:application
</pre></div>
</div>
<p>Notice no spots for variable substitution.
There&#8217;s no need; nothing we&#8217;re putting into this file is dependent upon the host system.</p>
<p>Our tasks will also be simple.
One for copying the code over and naming it <code class="docutils literal"><span class="pre">bookapp.conf</span></code>, and one for starting the new <code class="docutils literal"><span class="pre">bookapp</span></code> service.</p>
<p><strong>One</strong></p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Copy upstart script into /etc/init</span>
  <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">src=../templates/upstart_config dest=/etc/init/bookapp.conf</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
</pre></div>
</div>
<p><strong>Two</strong></p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Restart the bookapp upstart job</span>
  <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name=bookapp state=restarted</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
</pre></div>
</div>
<p>Done.</p>
</div>
<div class="section" id="wrapping-up">
<h2>Wrapping Up<a class="headerlink" href="#wrapping-up" title="Permalink to this headline">¶</a></h2>
<p>We now have a playbook that should work on any Ubuntu 14.04 system.
We could provision a new AWS EC2 instance right now and simply change the domain name, gettin a new application up and running in moments.
No need to memorize the steps, no need to ssh and execute steps manually.
One time is all you need.</p>
<p>We&#8217;ve gone through the basics of setting up an ansible playbook here, but there&#8217;s so much more to the Ansible ecosystem.
You&#8217;ll need to dive a bit deeper for deploying your full Django application, so spend some time getting cozy with the <a class="reference external" href="http://docs.ansible.com/ansible/">Ansible documentation</a> and Google, your bestest friend of all.</p>
<p>Finally, for this and other apps, many folks before you have sought to do the types of things you want to do.
Like with GitHub, there exists a place for these people to store their playbooks and roles: <a class="reference external" href="https://galaxy.ansible.com/">Ansible Galaxy</a>.
Take time to check that out, especially one of the roles that handles Nginx for you: <a class="reference external" href="https://galaxy.ansible.com/list#/roles?page=1&amp;page_size=10&amp;autocomplete=nginx">nginx search results</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Automated Deployment with Ansible</a><ul>
<li><a class="reference internal" href="#a-note-about-continuous-delivery-and-dev-ops">A Note about Continuous Delivery and Dev Ops</a></li>
<li><a class="reference internal" href="#introduction-to-ansible">Introduction to Ansible</a><ul>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#the-simplest-runs">The Simplest Runs</a></li>
<li><a class="reference internal" href="#local-host-not-localhost-inventory-list">Local Host (not &#8220;localhost&#8221;) Inventory List</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ansible-playbooks">Ansible Playbooks</a><ul>
<li><a class="reference internal" href="#tasks">Tasks</a><ul>
<li><a class="reference internal" href="#apt-module-and-looping">apt Module and Looping</a></li>
<li><a class="reference internal" href="#the-git-module">The git Module</a></li>
<li><a class="reference internal" href="#virtual-environments-and-the-pip-module">Virtual Environments and The pip Module</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#templates-and-configuring-nginx">Templates and Configuring Nginx</a><ul>
<li><a class="reference internal" href="#file-status">File Status</a></li>
<li><a class="reference internal" href="#conditionals">Conditionals</a></li>
<li><a class="reference internal" href="#ansible-templates">Ansible Templates</a><ul>
<li><a class="reference internal" href="#variables">Variables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#services">Services</a></li>
</ul>
</li>
<li><a class="reference internal" href="#getting-moving-with-upstart-and-gunicorn">Getting Moving with Upstart and Gunicorn</a></li>
<li><a class="reference internal" href="#wrapping-up">Wrapping Up</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">Python 401 2.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014-2016, Cris Ewing, Nicholas Hunt-Walker.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
  </body>
</html>